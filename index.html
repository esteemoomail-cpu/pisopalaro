<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PISO PALARO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}:root{--bg:#060919;--card:rgba(12,17,50,.92);--card2:rgba(20,26,60,.85);--gold:#ffd700;--goldd:#c9a200;--txt:#eef;--sub:#6a73a0;--bdr:rgba(255,215,0,.1);--ok:#00e676;--gc:#007aff;--err:#ff3b3b;--warn:#ff9100;--pend:#ffab00;--r:12px}html{scroll-behavior:smooth}body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden}body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 30% -10%,rgba(255,215,0,.06),transparent 60%),radial-gradient(ellipse at 70% 110%,rgba(0,122,255,.04),transparent 55%);pointer-events:none}.w{max-width:860px;margin:0 auto;padding:14px;position:relative;z-index:1}header{text-align:center;padding:30px 0 8px}.logo{font-size:clamp(2rem,7vw,3.3rem);font-weight:900;background:linear-gradient(135deg,var(--goldd),var(--gold),#fff8c4,var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:4px}.logo span{display:block;font-size:.38em;letter-spacing:12px;font-weight:300;-webkit-text-fill-color:var(--sub)}.tag{color:var(--sub);font-size:.85rem;margin-top:4px;letter-spacing:1px}.pill{display:inline-block;margin-top:12px;padding:7px 24px;background:linear-gradient(135deg,var(--goldd),var(--gold));color:#000;border-radius:50px;font-weight:800;font-size:.95rem}.range{margin-top:6px;color:var(--sub);font-size:.75rem;font-family:'JetBrains Mono',monospace;letter-spacing:2px}.draw-banner{background:linear-gradient(135deg,rgba(255,215,0,.1),rgba(255,215,0,.03));border:1px solid rgba(255,215,0,.15);border-radius:var(--r);padding:12px 18px;margin:14px 0;text-align:center;display:none}.draw-banner .db-label{font-size:.65rem;color:var(--sub);text-transform:uppercase;letter-spacing:2px;margin-bottom:2px}.draw-banner .db-date{font-size:1.1rem;font-weight:800;color:var(--gold);font-family:'JetBrains Mono',monospace}.announce-banner{background:linear-gradient(135deg,rgba(0,122,255,.1),rgba(0,122,255,.03));border:1px solid rgba(0,122,255,.18);border-radius:var(--r);padding:14px 18px;margin:14px 0;display:none;line-height:1.7;font-size:.88rem}.maint-overlay{display:none;position:fixed;inset:0;background:rgba(6,9,25,.97);z-index:9998;justify-content:center;align-items:center;flex-direction:column;text-align:center;padding:20px}.maint-overlay.on{display:flex}.maint-overlay .mi{font-size:4rem;margin-bottom:16px}.maint-overlay h2{color:var(--gold);font-size:1.5rem;margin-bottom:8px}.maint-overlay p{color:var(--sub);font-size:.92rem;max-width:400px;line-height:1.8}.info-bar{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:20px 24px;backdrop-filter:blur(10px);margin:22px 0}.info-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px}.date-box{display:flex;align-items:center;gap:10px}.date-icon{width:42px;height:42px;background:linear-gradient(135deg,rgba(255,215,0,.12),rgba(255,215,0,.04));border:1px solid rgba(255,215,0,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}.date-label{font-size:.65rem;color:var(--sub);text-transform:uppercase;letter-spacing:2px;margin-bottom:2px}.date-value{font-size:1.05rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--gold)}.avail-label{font-size:.65rem;color:var(--sub);text-transform:uppercase;letter-spacing:2px;text-align:right}.avail-status{font-size:.82rem;font-weight:600;margin-top:2px;text-align:right}.avail-status.high{color:var(--ok)}.avail-status.mid{color:var(--warn)}.avail-status.low{color:var(--err)}.progress-wrap{position:relative}.progress-track{width:100%;height:14px;background:rgba(255,255,255,.06);border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.05)}.progress-fill{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--ok),#69f0ae);transition:width 1.5s;position:relative}.progress-fill.mid{background:linear-gradient(90deg,var(--warn),#ffcc02)}.progress-fill.low{background:linear-gradient(90deg,var(--err),#ff6b6b)}.progress-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);animation:shimmer 2s infinite}@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}.progress-dots{display:flex;justify-content:space-between;margin-top:6px;padding:0 2px}.progress-dots span{width:1px;height:6px;background:rgba(255,255,255,.1)}.conn{display:flex;align-items:center;justify-content:center;gap:8px;margin:16px 0 8px;padding:10px;border-radius:var(--r);font-size:.8rem;font-weight:600;transition:.3s}.conn.checking{background:rgba(255,255,255,.05);color:var(--sub);border:1px solid rgba(255,255,255,.08)}.conn.online{background:rgba(0,230,118,.08);color:var(--ok);border:1px solid rgba(0,230,118,.15)}.conn.offline{background:rgba(255,59,59,.08);color:var(--err);border:1px solid rgba(255,59,59,.15)}.conn .dot{width:8px;height:8px;border-radius:50%}.conn.checking .dot{background:var(--sub);animation:pulse 1s infinite}.conn.online .dot{background:var(--ok)}.conn.offline .dot{background:var(--err)}@keyframes pulse{0%,100%{opacity:.3}50%{opacity:1}}.card{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:24px;backdrop-filter:blur(10px);margin-bottom:22px}.steps{display:flex;justify-content:center;align-items:center;margin-bottom:22px}.stp{display:flex;align-items:center;gap:5px;padding:7px 10px;font-size:.76rem;font-weight:600;color:var(--sub);transition:.3s}.stp .n{width:25px;height:25px;border-radius:50%;background:rgba(255,255,255,.07);display:flex;align-items:center;justify-content:center;font-size:.73rem;font-weight:700;transition:.3s}.stp.on{color:var(--gold)}.stp.on .n{background:var(--gold);color:#000}.stp.ok{color:var(--ok)}.stp.ok .n{background:var(--ok);color:#fff}.sln{width:28px;height:2px;background:rgba(255,255,255,.07);transition:.3s}.sln.on{background:var(--gold)}.ct{font-size:1.05rem;font-weight:700;margin-bottom:18px;display:flex;align-items:center;gap:7px}.fg{margin-bottom:14px}.fg label{display:block;font-size:.7rem;font-weight:600;color:var(--sub);margin-bottom:5px;text-transform:uppercase;letter-spacing:2px}.fg input,.fg textarea,.fg select{width:100%;padding:12px 13px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:10px;color:#fff;font-size:1rem;font-family:inherit;outline:none;transition:.3s}.fg input:focus,.fg textarea:focus,.fg select:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(255,215,0,.08)}.fg input::placeholder{color:rgba(255,255,255,.18)}.fg .field-err{color:var(--err);font-size:.7rem;margin-top:4px;display:none}.fr{display:grid;grid-template-columns:1fr 1fr;gap:12px}.tot{background:linear-gradient(135deg,rgba(255,215,0,.08),rgba(255,215,0,.02));border:1px dashed rgba(255,215,0,.2);border-radius:var(--r);padding:14px;text-align:center;margin:14px 0}.tot .tl{font-size:.66rem;color:var(--sub);text-transform:uppercase;letter-spacing:2px;margin-bottom:3px}.tot .tv{font-size:1.9rem;font-weight:900;color:var(--gold);font-family:'JetBrains Mono',monospace}.gc{background:linear-gradient(135deg,rgba(0,122,255,.1),rgba(0,122,255,.03));border:1px solid rgba(0,122,255,.18);border-radius:var(--r);padding:18px;margin:14px 0}.gc-h{display:flex;align-items:center;gap:7px;margin-bottom:10px;font-weight:700}.gc-b{background:var(--gc);color:#fff;padding:4px 11px;border-radius:6px;font-weight:800;font-size:.8rem}.gc-num{font-family:'JetBrains Mono',monospace;font-size:1.2rem;font-weight:700;color:#64b5f6;background:rgba(0,122,255,.12);padding:9px 16px;border-radius:8px;display:inline-block;margin:5px 0;cursor:pointer;user-select:all;border:1px dashed rgba(100,181,246,.3);transition:.2s}.gc-num:hover{background:rgba(0,122,255,.2)}
.btn{width:100%;padding:13px;border:none;border-radius:var(--r);font-size:.9rem;font-weight:700;font-family:inherit;cursor:pointer;transition:.25s;text-transform:uppercase;letter-spacing:2px}.b1{background:linear-gradient(135deg,var(--goldd),var(--gold));color:#000;box-shadow:0 4px 24px rgba(255,215,0,.2)}.b1:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 32px rgba(255,215,0,.3)}.b1:disabled{opacity:.4;cursor:not-allowed}.b2{background:rgba(255,255,255,.06);color:#fff;border:1px solid rgba(255,255,255,.1);margin-top:10px}.b2:hover{background:rgba(255,255,255,.1)}.receipt{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:24px;backdrop-filter:blur(10px)}.rh{text-align:center;padding-bottom:16px;border-bottom:1px dashed var(--bdr);margin-bottom:14px}.rh .ic{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.7rem;margin:0 auto 10px;animation:pop .4s}@keyframes pop{0%{transform:scale(0) rotate(-20deg)}60%{transform:scale(1.15) rotate(5deg)}100%{transform:scale(1)}}.rd{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;padding-bottom:14px;border-bottom:1px dashed var(--bdr)}.ri .rl{color:var(--sub);font-size:.63rem;text-transform:uppercase;letter-spacing:1.5px}.ri .rv{font-weight:600;margin-top:2px;font-size:.88rem;word-break:break-all}.ubadge{display:inline-flex;align-items:center;gap:4px;padding:4px 13px;border-radius:20px;font-size:.7rem;font-weight:700;letter-spacing:1px;margin:8px auto;text-transform:uppercase}.ubadge.pending{background:rgba(255,171,0,.1);border:1px solid rgba(255,171,0,.2);color:var(--pend)}.nt{font-weight:700;font-size:.95rem;margin-bottom:8px;display:flex;align-items:center;gap:6px}.nbox{max-height:480px;overflow-y:auto;padding:11px;background:rgba(0,0,0,.4);border-radius:10px;border:1px solid rgba(255,215,0,.06);margin:6px 0}.ngrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(98px,1fr));gap:4px}.ni{font-family:'JetBrains Mono',monospace;font-size:.88rem;font-weight:700;padding:7px 3px;background:linear-gradient(135deg,rgba(255,215,0,.06),rgba(255,215,0,.02));border:1px solid rgba(255,215,0,.1);border-radius:6px;text-align:center;color:var(--gold);letter-spacing:3px}.acts{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:14px}.acts .btn{padding:9px;font-size:.7rem;letter-spacing:1.5px}.ov{display:none;position:fixed;inset:0;background:rgba(6,9,25,.95);z-index:9999;justify-content:center;align-items:center;flex-direction:column;text-align:center;padding:20px}.ov.on{display:flex}.sp{width:50px;height:50px;border:4px solid rgba(255,215,0,.12);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:14px}@keyframes spin{to{transform:rotate(360deg)}}.ov-t{color:var(--gold);font-weight:600;font-size:.9rem;letter-spacing:1px;line-height:1.8}.ov-s{color:var(--sub);font-size:.78rem;margin-top:6px;line-height:1.6}.rb{width:240px;height:4px;background:rgba(255,255,255,.08);border-radius:3px;margin-top:14px;overflow:hidden;display:none}.rb .fl{height:100%;background:var(--gold);border-radius:3px}.toast{position:fixed;top:14px;right:14px;padding:12px 20px;border-radius:10px;font-weight:600;font-size:.85rem;z-index:10001;transform:translateX(150%);transition:transform .3s;max-width:400px;line-height:1.5}.toast.on{transform:translateX(0)}.toast.err{background:var(--err);color:#fff}.toast.suc{background:var(--ok);color:#000}.toast.warn{background:var(--warn);color:#000}.hide{display:none!important}.err-panel{background:linear-gradient(135deg,rgba(255,59,59,.1),rgba(255,59,59,.03));border:1px solid rgba(255,59,59,.2);border-radius:var(--r);padding:18px;margin:14px 0;line-height:1.8;font-size:.85rem}.err-panel h3{color:var(--err);margin-bottom:8px}.err-panel .retry-btn{display:inline-block;margin-top:10px;padding:8px 20px;background:var(--err);color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-family:inherit}footer{text-align:center;padding:24px 0;color:var(--sub);font-size:.68rem;line-height:2}
.pending-notice{background:linear-gradient(135deg,rgba(255,171,0,.1),rgba(255,171,0,.03));border:1px solid rgba(255,171,0,.2);border-radius:var(--r);padding:14px 18px;margin:12px 0;line-height:1.7;font-size:.85rem;color:var(--pend)}
.highlight-field{background:linear-gradient(135deg,rgba(255,215,0,.12),rgba(255,215,0,.04));border:1px solid rgba(255,215,0,.2);border-radius:10px;padding:12px 16px;margin:4px 0;cursor:pointer;transition:.2s;position:relative}.highlight-field:hover{background:linear-gradient(135deg,rgba(255,215,0,.18),rgba(255,215,0,.08));border-color:rgba(255,215,0,.35)}.highlight-field .rl{color:var(--gold)}.highlight-field .rv{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:800;color:var(--gold);letter-spacing:1px}.highlight-field .cp-hint{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:.65rem;color:var(--sub);opacity:.6;display:flex;align-items:center;gap:4px;transition:.2s}.highlight-field:hover .cp-hint{opacity:1;color:var(--gold)}
.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}.login-box{background:var(--card);border:1px solid var(--bdr);border-radius:20px;padding:40px 32px;width:100%;max-width:420px;backdrop-filter:blur(10px);text-align:center}.login-box h1{font-size:1.6rem;margin-bottom:4px;background:linear-gradient(135deg,var(--goldd),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.login-box .lsub{color:var(--sub);font-size:.82rem;margin-bottom:28px}.admin{display:none;min-height:100vh}.topbar{background:var(--card);border-bottom:1px solid var(--bdr);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;backdrop-filter:blur(10px)}.topbar h1{font-size:1.1rem;min-width:0;background:linear-gradient(135deg,var(--goldd),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.topbar .user{display:flex;align-items:center;gap:10px;font-size:.82rem;color:var(--sub)}.topbar .logout{padding:6px 14px;background:rgba(255,59,59,.1);border:1px solid rgba(255,59,59,.2);color:var(--err);border-radius:8px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:inherit;text-transform:uppercase;letter-spacing:1px}.mob-nav{display:none}.admain{display:flex;min-height:calc(100vh - 56px)}.sidebar{width:220px;background:var(--card);border-right:1px solid var(--bdr);padding:16px 0;flex-shrink:0;position:sticky;top:56px;height:calc(100vh - 56px);overflow-y:auto}.nav-item{display:flex;align-items:center;gap:10px;padding:11px 20px;font-size:.82rem;font-weight:500;color:var(--sub);cursor:pointer;transition:.2s;border-left:3px solid transparent}.nav-item:hover{background:rgba(255,215,0,.04);color:var(--txt)}.nav-item.active{background:rgba(255,215,0,.06);color:var(--gold);border-left-color:var(--gold);font-weight:700}.nav-sep{height:1px;background:var(--bdr);margin:10px 16px}.content{flex:1;padding:24px;overflow-y:auto}.page{display:none}.page.active{display:block}.page-title{font-size:1.4rem;font-weight:800;margin-bottom:6px}.page-sub{color:var(--sub);font-size:.82rem;margin-bottom:24px}.stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;margin-bottom:24px}.stat{background:var(--card2);border:1px solid var(--bdr);border-radius:14px;padding:18px;transition:.2s}.stat:hover{border-color:rgba(255,215,0,.2);transform:translateY(-1px)}.stat .sl{font-size:.65rem;color:var(--sub);text-transform:uppercase;letter-spacing:2px;margin-bottom:6px}.stat .sv{font-size:1.6rem;font-weight:800;font-family:'JetBrains Mono',monospace}.stat .sc{font-size:.7rem;margin-top:4px}.stat.gold .sv{color:var(--gold)}.stat.green .sv{color:var(--ok)}.stat.blue .sv{color:var(--gc)}.stat.red .sv{color:var(--err)}.stat.yellow .sv{color:var(--pend)}.tbl-wrap{background:var(--card2);border:1px solid var(--bdr);border-radius:14px;overflow:hidden;margin-bottom:20px}.tbl-head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--bdr);flex-wrap:wrap;gap:10px}.tbl-head h3{font-size:.95rem}.tbl-actions{display:flex;gap:8px}.btn-sm{padding:7px 14px;border:none;border-radius:8px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:inherit;transition:.2s;text-transform:uppercase;letter-spacing:1px}.btn-gold{background:linear-gradient(135deg,var(--goldd),var(--gold));color:#000}.btn-blue{background:rgba(0,122,255,.15);border:1px solid rgba(0,122,255,.2);color:#64b5f6}.btn-red{background:rgba(255,59,59,.12);border:1px solid rgba(255,59,59,.2);color:var(--err)}.btn-green{background:rgba(0,230,118,.12);border:1px solid rgba(0,230,118,.2);color:var(--ok)}.btn-orange{background:rgba(255,145,0,.12);border:1px solid rgba(255,145,0,.2);color:var(--warn)}table{width:100%;border-collapse:collapse}th{padding:10px 14px;text-align:left;font-size:.68rem;text-transform:uppercase;letter-spacing:2px;color:var(--sub);border-bottom:1px solid var(--bdr);background:rgba(0,0,0,.2);white-space:nowrap}td{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.03);font-size:.82rem;white-space:nowrap}tr:hover td{background:rgba(255,215,0,.02)}.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:1px}.badge.ok{background:rgba(0,230,118,.1);color:var(--ok)}.badge.pend{background:rgba(255,171,0,.1);color:var(--pend)}.badge.fail{background:rgba(255,59,59,.1);color:var(--err)}.badge.dec{background:rgba(255,59,59,.1);color:var(--err)}.mono{font-family:'JetBrains Mono',monospace;letter-spacing:2px;color:var(--gold)}.tbl-empty{padding:40px;text-align:center;color:var(--sub);font-size:.88rem}.pagination{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px;border-top:1px solid var(--bdr)}.pg-btn{padding:6px 12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:6px;color:var(--txt);font-size:.78rem;cursor:pointer;font-family:inherit}.pg-btn:disabled{opacity:.3;cursor:not-allowed}.pg-btn.active{background:var(--gold);color:#000;font-weight:700}.pg-info{font-size:.75rem;color:var(--sub)}.settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}.setting-group{background:var(--card2);border:1px solid var(--bdr);border-radius:14px;padding:20px;margin-bottom:16px}.setting-group h3{font-size:.9rem;margin-bottom:14px;display:flex;align-items:center;gap:8px}.fg textarea{resize:vertical;min-height:80px}.fg select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236a73a0'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}.tool-card{background:var(--card2);border:1px solid var(--bdr);border-radius:14px;padding:20px;margin-bottom:16px}.tool-card h3{font-size:.9rem;margin-bottom:12px;display:flex;align-items:center;gap:8px}.tool-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}.tool-row .fg{flex:1;min-width:160px;margin-bottom:0}.bar-track{width:100%;height:8px;background:rgba(255,255,255,.06);border-radius:6px;overflow:hidden;margin-top:8px}.bar-fill{height:100%;border-radius:6px;transition:width 1s;background:linear-gradient(90deg,var(--ok),#69f0ae)}.bar-fill.mid{background:linear-gradient(90deg,var(--warn),#ffcc02)}.bar-fill.low{background:linear-gradient(90deg,var(--err),#ff6b6b)}.feed{list-style:none}.feed li{padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.03);display:flex;align-items:center;gap:12px;font-size:.82rem}.feed li:last-child{border-bottom:none}.feed .dot{width:8px;height:8px;border-radius:50%}.feed .dot.ok{background:var(--ok)}.feed .dot.pend{background:var(--pend)}.feed .dot.fail{background:var(--err)}.feed .dot.dec{background:var(--err)}.feed .time{color:var(--sub);font-size:.7rem;font-family:'JetBrains Mono',monospace;white-space:nowrap}
.confirm-modal{display:none;position:fixed;inset:0;background:rgba(6,9,25,.92);z-index:10000;justify-content:center;align-items:center;padding:20px;overflow-y:auto}.confirm-modal.on{display:flex}.confirm-box{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:28px;max-width:420px;width:100%;text-align:center}.confirm-box h3{margin-bottom:8px}.confirm-box p{color:var(--sub);font-size:.85rem;margin-bottom:20px;line-height:1.7}.confirm-box code{background:rgba(0,0,0,.4);padding:2px 8px;border-radius:4px;font-family:'JetBrains Mono',monospace;color:var(--gold)}.confirm-btns{display:flex;gap:10px;justify-content:center}.confirm-btns .btn-sm{padding:10px 24px;font-size:.8rem}
.detail-modal{display:none;position:fixed;inset:0;background:rgba(6,9,25,.94);z-index:10000;justify-content:center;align-items:flex-start;padding:30px 20px;overflow-y:auto}.detail-modal.on{display:flex}.detail-box{background:var(--card);border:1px solid var(--bdr);border-radius:16px;padding:28px;max-width:700px;width:100%;margin:auto}.detail-box h2{font-size:1.2rem;margin-bottom:4px;display:flex;align-items:center;gap:8px}.detail-sub{color:var(--sub);font-size:.78rem;margin-bottom:18px}.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px;padding-bottom:18px;border-bottom:1px dashed var(--bdr)}.detail-grid .ri .rl{color:var(--sub);font-size:.63rem;text-transform:uppercase;letter-spacing:1.5px}.detail-grid .ri .rv{font-weight:600;margin-top:2px;font-size:.88rem;word-break:break-all}.detail-nums{margin:14px 0}.detail-nums h3{font-size:.9rem;margin-bottom:8px;display:flex;align-items:center;gap:6px}.detail-actions{display:flex;gap:8px;margin-top:18px;padding-top:18px;border-top:1px dashed var(--bdr);flex-wrap:wrap;justify-content:center}
.clickable-row{cursor:pointer;transition:.2s}.clickable-row:hover td{background:rgba(255,215,0,.06)!important}
.row-deleting{opacity:0;transform:translateX(40px);transition:all .4s ease}::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:rgba(255,255,255,.02)}::-webkit-scrollbar-thumb{background:rgba(255,215,0,.15);border-radius:3px}
.pub-link{display:block;margin-top:20px;color:var(--gc);font-size:.82rem;font-weight:600;text-decoration:none;transition:.2s}.pub-link:hover{color:var(--gold)}.pub-link-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;background:rgba(0,122,255,.1);border:1px solid rgba(0,122,255,.2);color:#64b5f6;border-radius:10px;font-size:.78rem;font-weight:700;text-decoration:none;transition:.2s;white-space:nowrap}.pub-link-btn:hover{background:rgba(0,122,255,.2);color:#fff;transform:translateY(-1px)}
.tx-actions{display:flex;gap:4px;flex-wrap:wrap}

.ref-row{margin:6px 0;padding:10px 0}.ref-label{font-size:.68rem;color:var(--sub);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:5px}.ref-val-wrap{display:flex;align-items:center;gap:10px}.ref-val{font-family:'JetBrains Mono',monospace;font-size:.95rem;font-weight:700;color:var(--txt);word-break:break-all;flex:1}.copy-btn{flex-shrink:0;padding:5px 12px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:6px;color:var(--sub);font-size:.72rem;font-weight:600;cursor:pointer;font-family:inherit;transition:.2s;text-transform:uppercase;letter-spacing:1px}.copy-btn:hover{background:rgba(255,255,255,.13);color:var(--txt)}
/* â˜… Quick-pick stacking buttons */
.qp-wrap{margin-bottom:14px}
.qp-label{font-size:.7rem;font-weight:600;color:var(--sub);text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
.qp-label .qp-reset{font-size:.65rem;color:var(--sub);cursor:pointer;text-transform:none;letter-spacing:0;padding:2px 8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:4px;font-weight:500;transition:.2s}
.qp-label .qp-reset:hover{color:var(--err);border-color:rgba(255,59,59,.3)}
.qp-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
.qp-btn{padding:9px 4px;background:rgba(255,215,0,.06);border:1px solid rgba(255,215,0,.15);border-radius:9px;color:var(--gold);font-size:.78rem;font-weight:700;cursor:pointer;font-family:inherit;transition:.2s;text-align:center;line-height:1.3}
.qp-btn:hover{background:rgba(255,215,0,.14);border-color:rgba(255,215,0,.35);transform:translateY(-1px)}
.qp-btn:active{transform:translateY(0)}
.qp-btn.max-btn{background:linear-gradient(135deg,rgba(255,215,0,.15),rgba(255,215,0,.06));border-color:rgba(255,215,0,.3)}
.qp-added{background:rgba(0,230,118,.1);border-color:rgba(0,230,118,.35);color:var(--ok);animation:qpFlash .35s ease}
@keyframes qpFlash{0%{transform:scale(1.08)}60%{transform:scale(.97)}100%{transform:scale(1)}}
.qp-stack-display{display:flex;align-items:center;gap:6px;font-size:.72rem;color:var(--sub);margin-top:7px;min-height:20px;flex-wrap:wrap}
.qp-stack-display .qp-chip{background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.2);border-radius:4px;padding:2px 7px;color:var(--gold);font-family:'JetBrains Mono',monospace;font-size:.7rem;font-weight:700}
@media(max-width:500px){.qp-grid{grid-template-columns:repeat(3,1fr)}.info-bar{padding:16px}.info-top{flex-direction:column;align-items:flex-start;gap:12px}.avail-label,.avail-status{text-align:left}.fr{grid-template-columns:1fr}.card{padding:16px}.ngrid{grid-template-columns:repeat(auto-fill,minmax(82px,1fr))}.acts{grid-template-columns:1fr}.rd{grid-template-columns:1fr}.detail-grid{grid-template-columns:1fr}.stp .stx{display:none}.stp{padding:7px 6px}.highlight-field .cp-hint{display:none}}
@media(max-width:768px){
.sidebar{display:none}
.admain{flex-direction:column}
.content{padding:12px;overflow-x:hidden}
/* Stats: 2-col grid, orphan last card spans full width */
.stats{grid-template-columns:repeat(2,1fr)}
.stats>.stat:last-child:nth-child(odd){grid-column:span 2}
.stat{padding:14px}
.stat .sv{font-size:1.3rem}
/* Settings */
.settings-grid{grid-template-columns:1fr}
/* Table header */
.tbl-head{flex-direction:column;align-items:stretch;padding:10px 12px}
.tbl-head h3{font-size:.85rem}
.tbl-actions{flex-wrap:wrap;gap:6px}
/* Tables: allow cells to wrap, tighter padding */
table{font-size:.73rem}
th{padding:7px 8px;font-size:.6rem;letter-spacing:1px}
td{padding:7px 8px;white-space:normal;vertical-align:top}
/* Keep number/id columns tight and no-wrap */
td.mono,td:nth-child(2){white-space:nowrap}
/* Shrink action buttons so they fit */
.tx-actions{flex-wrap:nowrap;gap:3px}
.tx-actions .btn-sm{padding:5px 7px;font-size:.63rem;letter-spacing:0}
/* Feed (Recent Activity) â€” allow wrapping */
.feed li{flex-wrap:wrap;gap:6px;padding:9px 12px}
.feed .time{white-space:normal;word-break:break-all;font-size:.65rem}
.feed li>strong{word-break:break-word}
/* Topbar: shorten on mobile */
.topbar{padding:10px 14px}
.topbar h1{font-size:.88rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px}
.topbar .user{gap:6px;font-size:.75rem}
.topbar .logout{padding:5px 10px;font-size:.7rem;letter-spacing:0}
/* Sticky mobile nav */
.mob-nav{display:flex!important;position:sticky;top:0;z-index:99;overflow-x:auto;gap:0;padding:0;background:var(--card);border-bottom:1px solid var(--bdr);scrollbar-width:none}
.mob-nav::-webkit-scrollbar{display:none}
.mob-nav .nav-item{border-left:none;border-bottom:3px solid transparent;white-space:nowrap;padding:10px 13px;font-size:.72rem;flex-shrink:0}
.mob-nav .nav-item.active{border-bottom-color:var(--gold);background:rgba(255,215,0,.05)}
/* Tool rows */
.tool-row{flex-direction:column}
.tool-row .fg{min-width:100%}
/* Detail modal */
.detail-box{padding:16px;margin:0}
.detail-modal{padding:12px 8px}
/* Page title tighter */
.page-title{font-size:1.15rem}
.page-sub{font-size:.75rem;margin-bottom:16px}
}
@media(min-width:769px){.mob-nav{display:none!important}}
</style>
</head>
<body>
<div class="ov" id="ov"><div class="sp"></div><div class="ov-t" id="ovT"></div><div class="ov-s" id="ovS"></div><div class="rb" id="rb"><div class="fl" id="rf"></div></div></div>
<div class="toast" id="toast"></div>
<div class="confirm-modal" id="confirmModal"><div class="confirm-box"><h3 id="confirmTitle"></h3><p id="confirmMsg"></p><div class="confirm-btns"><button class="btn-sm btn-red" id="confirmYes">Yes</button><button class="btn-sm btn-blue" onclick="closeConfirm()">Cancel</button></div></div></div>
<div class="detail-modal" id="detailModal"><div class="detail-box"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><h2 id="detailTitle">ğŸ“‹ Transaction Detail</h2><div class="detail-sub" id="detailSub"></div></div><button class="btn-sm btn-blue" onclick="closeDetail()" style="flex-shrink:0">âœ• Close</button></div><div class="detail-grid" id="detailGrid"></div><div class="detail-nums" id="detailNums"></div><div class="detail-actions" id="detailActions"></div></div></div>
<div class="maint-overlay" id="maintOverlay"><div class="mi">ğŸ”§</div><h2>Under Maintenance</h2><p>Purchases temporarily paused.</p></div>

<!-- â•â•â• PUBLIC PAGE â•â•â• -->
<div id="publicPage">
<div class="w">
<header><div class="logo" id="logoText">ğŸ° PISO<span>PALARO</span></div><p class="tag" id="tagLine">Get your lucky numbers â€” only â‚±1 each!</p><div class="pill" id="priceTag">â‚±1SO PER ENTRY</div></header>
<div class="draw-banner" id="drawBanner"><div class="db-label">ğŸ¯ Draw Date</div><div class="db-date" id="drawDateText"></div></div>
<div class="announce-banner" id="announceBanner"><span style="font-size:1.2rem;margin-right:6px">ğŸ“¢</span><span id="announceText"></span></div>
<div class="conn checking" id="connBar"><div class="dot"></div><span id="connTxt">Connecting...</span></div>
<div id="errPanel" class="err-panel hide"><h3>âš ï¸ Connection Failed</h3><div id="errDetail"></div></div>
<div class="info-bar"><div class="info-top"><div class="date-box"><div class="date-icon">ğŸ“…</div><div><div class="date-label">Today</div><div class="date-value" id="dateToday">â€”</div></div></div><div><div class="avail-label">Availability</div><div class="avail-status high" id="availTxt">Loading...</div></div></div><div class="progress-wrap"><div class="progress-track"><div class="progress-fill" id="progressFill" style="width:100%"></div></div><div class="progress-dots"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div></div></div>
<div id="secB"><div class="card"><div class="steps"><div class="stp on" id="i1"><div class="n">1</div><span class="stx">Details</span></div><div class="sln" id="l1"></div><div class="stp" id="i2"><div class="n">2</div><span class="stx">Payment</span></div><div class="sln" id="l2"></div><div class="stp" id="i3"><div class="n">3</div><span class="stx">Complete</span></div></div>
<div id="p1"><div class="ct">ğŸ“ Your Details</div><div class="fr"><div class="fg"><label>Full Name</label><input id="fN" placeholder="e.g. Juan Dela Cruz" autocomplete="name" maxlength="60"></div><div class="fg"><label>Phone <span style="font-weight:400;text-transform:none;color:var(--sub)">(11 digits)</span></label><input id="fP" type="tel" maxlength="11" placeholder="09171234567" autocomplete="tel"><div class="field-err" id="phoneErr"></div></div></div><div class="qp-wrap">
<div class="qp-label">Quick Pick <span class="qp-reset" onclick="resetQty()">âœ• Reset</span></div>
<div class="qp-grid">
  <button class="qp-btn" onclick="addQty(100)">+100</button>
  <button class="qp-btn" onclick="addQty(200)">+200</button>
  <button class="qp-btn" onclick="addQty(500)">+500</button>
  <button class="qp-btn" onclick="addQty(1000)">+1,000</button>
  <button class="qp-btn" onclick="addQty(5000)">+5,000</button>
  <button class="qp-btn max-btn" onclick="setMaxQtyFn()">MAX</button>
</div>
</div>
<div class="fg"><label id="qtyLabel">Total Quantity <span style="font-weight:400;text-transform:none;color:var(--sub)">(min <span id="minQtySpan">100</span>)</span></label><input id="fQ" type="number" min="100" max="10000" placeholder="Or type manually"></div><div class="tot"><div class="tl">Total</div><div class="tv" id="dT">â‚± 0.00</div></div><button class="btn b1" onclick="go2()">Continue to Payment â†’</button></div>
<div id="p2" class="hide"><div class="ct">ğŸ’³ GCash Payment</div><div class="gc"><div class="gc-h"><div class="gc-b">GCash</div> Send To:</div><div style="line-height:2.2"><strong>Name:</strong> <span id="dN"></span><br><strong>Number:</strong><br><div class="gc-num" id="dP" onclick="cpGC()" title="Copy"></div><br><strong>Amount:</strong> <span style="color:var(--gold);font-weight:800;font-size:1.1rem" id="dA"></span></div>
<div style="margin-top:14px;padding:12px 14px;background:rgba(0,122,255,.07);border:1px solid rgba(0,122,255,.15);border-radius:10px;font-size:.82rem;line-height:1.7;color:#a8c8f8">
  <div>ğŸ“‹ After sending the payment, please input the GCash reference number below.</div>
  <div style="margin-top:6px;color:var(--warn)">ğŸ“¸ <strong>It is highly recommended to take a screenshot of your GCash payment as back-up proof.</strong></div>
</div>
</div><div class="fg"><label>GCash Reference #</label><input id="fR" placeholder="Enter ref from receipt" autocomplete="off" maxlength="13"></div><button class="btn b1" id="buyBtn" onclick="submitPurchase()">âœ“ Confirm Entry</button><button class="btn b2" onclick="go1()">â† Back</button></div></div></div>

<div id="secR" class="hide"><div class="receipt"><div class="rh"><div class="ic" style="background:var(--pend)">â³</div><h2 style="font-size:1.3rem;margin-bottom:3px">Entry Submitted!</h2><p style="color:var(--sub);font-size:.83rem">Your numbers are reserved and pending approval.</p><div class="ubadge pending">â³ Pending Approval</div></div>
<div class="pending-notice">â³ <strong>Your entry is pending admin approval.</strong> Your numbers are reserved and will be confirmed once payment is verified. Save your Transaction ID and GCash Reference below.</div>
<div class="ref-row"><div class="ref-label">ğŸ“Œ Transaction ID</div><div class="ref-val-wrap"><span class="ref-val" id="rI"></span><button class="copy-btn" onclick="cpField('rI')">Copy</button></div></div>
<div class="ref-row" style="margin-bottom:14px"><div class="ref-label">ğŸ’³ GCash Reference #</div><div class="ref-val-wrap"><span class="ref-val" id="rR"></span><button class="copy-btn" onclick="cpField('rR')">Copy</button></div></div>
<div class="rd"><div class="ri"><div class="rl">Date</div><div class="rv" id="rD"></div></div><div class="ri"><div class="rl">Name</div><div class="rv" id="rN"></div></div><div class="ri"><div class="rl">Phone</div><div class="rv" id="rP"></div></div><div class="ri"><div class="rl">Quantity</div><div class="rv" id="rQ"></div></div><div class="ri"><div class="rl">Amount</div><div class="rv" style="color:var(--gold)" id="rA"></div></div><div class="ri"><div class="rl">Status</div><div class="rv" style="color:var(--pend);font-weight:800" id="rS">â³ PENDING</div></div></div>
<div class="nt">ğŸ° Your Numbers (<span id="rC">0</span>)</div><div class="nbox"><div class="ngrid" id="nG"></div></div><div class="acts"><button class="btn b2" onclick="cpA()">ğŸ“‹ Copy</button><button class="btn b2" onclick="dlA()">â¬‡ Download</button><button class="btn b2" onclick="prA()">ğŸ–¨ Print</button></div><button class="btn b1" style="margin-top:16px" onclick="again()">ğŸ° Buy More</button></div></div>
<footer>Â© 2024 Piso Palaro &bull; GCash only</footer>
</div></div>

<!-- â•â•â• ADMIN PAGE â•â•â• -->
<div id="adminPage" style="display:none">
<div id="adminLogin" class="login-wrap"><div class="login-box"><h1>ğŸ” PISO PALARO</h1><div class="lsub">Admin Panel</div><div class="fg"><label>Username</label><input id="loginUser" placeholder="Username"></div><div class="fg"><label>Password</label><input id="loginPass" type="password" placeholder="Password"></div><button class="btn b1" id="loginBtn" onclick="doLogin()">ğŸ”‘ Sign In</button><a href="#" onclick="goToPublicPage();return false" class="pub-link">ğŸ° Go to Public Page â†’</a></div></div>
<div class="admin" id="adminPanel">
<div class="topbar"><h1>ğŸ° PISO PALARO â€” Admin</h1><div class="user"><span id="adminUser">admin</span><button class="logout" onclick="doLogout()">Logout</button></div></div>
<div class="mob-nav"><div class="nav-item active" onclick="goPage('dashboard')">ğŸ“Š Dashboard</div><div class="nav-item" onclick="goPage('transactions')">ğŸ“‹ TX</div><div class="nav-item" onclick="goPage('numbers')">ğŸ”¢ Numbers</div><div class="nav-item" onclick="goPage('search')">ğŸ” Search</div><div class="nav-item" onclick="goPage('tools')">ğŸ”§ Tools</div><div class="nav-item" onclick="goPage('settings')">âš™ï¸ Settings</div></div>
<div class="admain">
<div class="sidebar"><div class="nav-item active" data-page="dashboard" onclick="goPage('dashboard')">ğŸ“Š Dashboard</div><div class="nav-item" data-page="transactions" onclick="goPage('transactions')">ğŸ“‹ Transactions</div><div class="nav-item" data-page="numbers" onclick="goPage('numbers')">ğŸ”¢ Sold Numbers</div><div class="nav-sep"></div><div class="nav-item" data-page="search" onclick="goPage('search')">ğŸ” Search</div><div class="nav-item" data-page="tools" onclick="goPage('tools')">ğŸ”§ Tools</div><div class="nav-sep"></div><div class="nav-item" data-page="settings" onclick="goPage('settings')">âš™ï¸ Settings</div></div>
<div class="content">

<!-- DASHBOARD -->
<div class="page active" id="pg-dashboard"><div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:8px"><div><div class="page-title">Dashboard</div><div class="page-sub" style="margin-bottom:0">Real-time overview</div></div><a href="#" onclick="goToPublicPage();return false" class="pub-link-btn">ğŸ° Public Page â†—</a></div><div class="stats"><div class="stat gold"><div class="sl">Total Sold</div><div class="sv" id="dsSold">â€”</div><div class="bar-track"><div class="bar-fill" id="dsBar" style="width:0"></div></div></div><div class="stat green"><div class="sl">Remaining</div><div class="sv" id="dsRemain">â€”</div><div class="sc" id="dsPct" style="color:var(--ok)">â€”</div></div><div class="stat blue"><div class="sl">Revenue (Approved)</div><div class="sv" id="dsRevenue">â€”</div></div><div class="stat yellow"><div class="sl">Pending</div><div class="sv" id="dsPending">â€”</div></div><div class="stat green"><div class="sl">Approved</div><div class="sv" id="dsApproved">â€”</div></div><div class="stat red"><div class="sl">Declined</div><div class="sv" id="dsDeclined">â€”</div></div><div class="stat blue"><div class="sl">Unique Buyers</div><div class="sv" id="dsBuyers">â€”</div></div></div><div class="tbl-wrap"><div class="tbl-head"><h3>ğŸ“¡ Recent Activity</h3><button class="btn-sm btn-blue" onclick="cacheClear('admin_');loadDashboard()">â†» Refresh</button></div><ul class="feed" id="feedList"><li class="tbl-empty">Loading...</li></ul></div></div>

<!-- TRANSACTIONS -->
<div class="page" id="pg-transactions"><div class="page-title">Transactions</div><div class="page-sub">Click any row to view details</div><div class="tbl-wrap"><div class="tbl-head"><h3>ğŸ“‹ Log</h3><div class="tbl-actions"><button class="btn-sm btn-green" onclick="exportData('transactions')">â¬‡ Export</button><button class="btn-sm btn-blue" onclick="cacheClear('admin_tx');loadTransactions()">â†»</button><button class="btn-sm btn-red" onclick="confirmDeleteAll()">ğŸ—‘ Delete All</button></div></div><div style="overflow-x:auto"><table><thead><tr><th>Date</th><th>TX ID</th><th>Name</th><th>Phone</th><th>GCash</th><th>Qty</th><th>Amt</th><th>Status</th><th>Actions</th></tr></thead><tbody id="txBody"><tr><td colspan="9" class="tbl-empty">Loading...</td></tr></tbody></table></div><div class="pagination" id="txPagination"></div></div></div>

<!-- NUMBERS -->
<div class="page" id="pg-numbers"><div class="page-title">Sold Numbers</div><div class="page-sub">Click any row to view transaction details</div><div class="tbl-wrap"><div class="tbl-head"><h3>ğŸ”¢ Registry</h3><div class="tbl-actions"><button class="btn-sm btn-green" onclick="exportData('sold')">â¬‡ Export</button><button class="btn-sm btn-blue" onclick="cacheClear('admin_num');loadNumbers()">â†»</button></div></div><div style="overflow-x:auto"><table><thead><tr><th>Number</th><th>TX ID</th><th>Name</th><th>Phone</th><th>GCash</th><th>Date</th></tr></thead><tbody id="numBody"><tr><td colspan="6" class="tbl-empty">Loading...</td></tr></tbody></table></div><div class="pagination" id="numPagination"></div></div></div>

<!-- SEARCH -->
<div class="page" id="pg-search"><div class="page-title">Search</div><div class="page-sub">Click any result to view full transaction details</div><div class="tool-card"><h3>ğŸ” By Number</h3><div class="tool-row"><div class="fg"><label>6-Digit</label><input id="searchNum" maxlength="6" placeholder="042069"></div><button class="btn-sm btn-gold" onclick="searchNumber()" style="height:42px">Search</button></div></div><div class="tool-card"><h3>ğŸ‘¤ By Buyer</h3><div class="tool-row"><div class="fg"><label>Name / Phone / TX / GCash</label><input id="searchBuyer" placeholder="Juan"></div><button class="btn-sm btn-gold" onclick="searchBuyerFn()" style="height:42px">Search</button></div></div><div class="tbl-wrap" id="searchResults" style="display:none"><div class="tbl-head"><h3 id="searchTitle"></h3></div><div style="overflow-x:auto"><table><thead id="searchThead"></thead><tbody id="searchTbody"></tbody></table></div></div></div>

<!-- TOOLS -->
<div class="page" id="pg-tools"><div class="page-title">Tools</div><div class="page-sub">Manual ops</div><div class="tool-card"><h3>â• Add Number</h3><div class="tool-row"><div class="fg"><label>Number</label><input id="addNum" maxlength="6" placeholder="123456"></div><div class="fg"><label>Name</label><input id="addName" placeholder="Optional"></div><div class="fg"><label>Phone</label><input id="addPhone" maxlength="11" placeholder="Optional"></div><button class="btn-sm btn-green" onclick="addNumber()" style="height:42px">Add</button></div></div><div class="tool-card"><h3>â– Remove Number</h3><div class="tool-row"><div class="fg"><label>Number</label><input id="removeNum" maxlength="6" placeholder="123456"></div><button class="btn-sm btn-red" onclick="removeNumber()" style="height:42px">Remove</button></div></div><div class="tool-card"><h3>ğŸ“¥ Export</h3><div style="display:flex;gap:10px;flex-wrap:wrap"><button class="btn-sm btn-green" onclick="exportData('sold')">â¬‡ Sold CSV</button><button class="btn-sm btn-blue" onclick="exportData('transactions')">â¬‡ TX CSV</button></div></div></div>

<!-- SETTINGS -->
<div class="page" id="pg-settings">
<div class="page-title">Settings</div>
<div class="page-sub">Live config</div>
<div class="settings-grid">
  <div class="setting-group"><h3>ğŸ’³ GCash</h3>
    <div class="fg"><label>Name</label><input id="setGcashName"></div>
    <div class="fg"><label>Number</label><input id="setGcashNum"></div>
  </div>
  <div class="setting-group"><h3>ğŸ° Lottery</h3>
    <div class="fg"><label>Name</label><input id="setLotteryName"></div>
    <div class="fg"><label>Draw Date</label><input id="setDrawDate" type="date"></div>
  </div>
  <div class="setting-group"><h3>ğŸ”¢ Limits</h3>
    <div class="fg"><label>Price (â‚±)</label><input id="setPrice" type="number" min="1"></div>
    <div class="fg"><label>Min Qty</label><input id="setMinQty" type="number" min="1"></div>
    <div class="fg"><label>Max Qty</label><input id="setMaxQty" type="number" min="1"></div>
  </div>
  <div class="setting-group"><h3>ğŸ“¢ Announcement</h3>
    <div class="fg"><label>Message</label><textarea id="setAnnouncement" placeholder="Blank = hidden"></textarea></div>
    <div class="fg"><label>Maintenance</label><select id="setMaintenance"><option value="false">Off</option><option value="true">On</option></select></div>
  </div>
</div>

<div class="setting-group"><h3>ğŸ” Password</h3><div class="settings-grid"><div class="fg"><label>New</label><input id="setNewPass" type="password" placeholder="Min 6"><small>Blank = keep</small></div><div class="fg"><label>Confirm</label><input id="setNewPass2" type="password" placeholder="Repeat"></div></div></div>
<button class="btn b1" onclick="saveSettings()" style="max-width:300px">ğŸ’¾ Save Settings</button>
</div>

</div></div></div></div>
</div>

<script>
const SCRIPT_URL='https://script.google.com/macros/s/AKfycbyYp99PDMVG6wOa71eFHAuhNZxcKwCU38jgpStBygEvuyZAHLtAGytuyKLb4fFuWfZADw/exec';
const ADMIN_SECRET='admin';
let GCASH_NUMBER='0917-123-4567',GCASH_NAME='Juan Dela Cruz',PRICE_PER=1,MIN_QTY=100,MAX_QTY=10000,LOTTERY_NAME='PISO PALARO';
const MAX_RETRY=3,RETRY_MS=[3000,5000,8000],FETCH_TIMEOUT=60000,TOTAL_POOL=200000;
let myNums=[],serverOnline=false,TOKEN='',currentPage={tx:1,num:1},IS_ADMIN_MODE=false;
let _detailTx=null;
const CACHE={};const SRV_MS=60000;const UI_MS=500;
// Persist cache to sessionStorage so re-navigating between tabs is instant
function cacheSet(k,d){CACHE[k]={data:d,time:Date.now()};try{sessionStorage.setItem('pp_'+k,JSON.stringify({data:d,time:Date.now()}))}catch(e){}}
function cacheGet(k){if(CACHE[k])return CACHE[k];try{var s=sessionStorage.getItem('pp_'+k);if(s){var p=JSON.parse(s);CACHE[k]=p;return p}}catch(e){}return null}
function cacheAge(k){var c=cacheGet(k);return c?Date.now()-c.time:Infinity}
function cacheClear(p){Object.keys(CACHE).forEach(k=>{if(!p||k.startsWith(p))delete CACHE[k]});try{Object.keys(sessionStorage).forEach(k=>{if(k.startsWith('pp_')&&(!p||k.startsWith('pp_'+p)))sessionStorage.removeItem(k)})}catch(e){}}
// swr: render cache INSTANTLY, always refresh in background
async function swr(ck,fn,render){
  var c=cacheGet(ck);
  if(c)render(c.data); // instant â€” no waiting
  // Always fetch fresh in background unless cache is very new (<3s)
  if(cacheAge(ck)<3000)return c?c.data:null;
  try{var f=await fn();if(f){cacheSet(ck,f);render(f)}return f}catch(e){if(!c)throw e;return c.data}
}
function pad6(n){return String(n).padStart(6,'0').substring(0,6)}
function detectMode(){if(new URLSearchParams(location.search).get('access')===ADMIN_SECRET){IS_ADMIN_MODE=true;document.getElementById('publicPage').style.display='none';document.getElementById('adminPage').style.display='block';document.title='Admin'}else{document.getElementById('publicPage').style.display='block';document.getElementById('adminPage').style.display='none'}}
function toast(m,t){var e=document.getElementById('toast');e.textContent=m;e.className='toast '+t+' on';clearTimeout(e._t);e._t=setTimeout(()=>e.classList.remove('on'),4000)}
function showOv(t,s){document.getElementById('ovT').textContent=t||'';document.getElementById('ovS').textContent=s||'';document.getElementById('ov').classList.add('on')}
function hideOv(){document.getElementById('ov').classList.remove('on')}
function closeConfirm(){document.getElementById('confirmModal').classList.remove('on')}
function closeDetail(){document.getElementById('detailModal').classList.remove('on');_detailTx=null}
function show(id){document.getElementById(id).classList.remove('hide')}
function hide(id){document.getElementById(id).classList.add('hide')}
function goToPublicPage(){window.open(location.href.split('?')[0],'_blank')}
function cpField(id){var txt=document.getElementById(id).textContent;navigator.clipboard.writeText(txt).then(()=>toast('ğŸ“‹ Copied: '+txt,'suc')).catch(()=>toast('Copy failed','err'))}
async function safeFetch(url,ms){var c=new AbortController(),t=setTimeout(()=>c.abort(),ms||FETCH_TIMEOUT);try{var r=await fetch(url,{redirect:'follow',signal:c.signal});clearTimeout(t);var txt=await r.text();if(txt.trim().startsWith('<!DOCTYPE'))throw new Error(txt.includes('accounts.google.com')?'AUTH_ERROR':'HTML_RESPONSE');try{return JSON.parse(txt)}catch(e){var m=txt.match(/\{[\s\S]*\}/);if(m)return JSON.parse(m[0]);throw new Error('PARSE_ERROR')}}catch(err){clearTimeout(t);if(err.name==='AbortError')throw new Error('TIMEOUT');throw err}}
function getFriendlyError(e){return{short:e.message,detail:'<button class="retry-btn" onclick="checkConnection()">ğŸ”„ Retry</button>'}}
function parseDrawDate(s){if(!s)return null;s=String(s).trim();if(!s)return null;var p=s.split('-');if(p.length===3){var y=parseInt(p[0]),m=parseInt(p[1])-1,d=parseInt(p[2]);if(!isNaN(y)&&!isNaN(m)&&!isNaN(d)&&y>2000)return new Date(y,m,d)}var f=new Date(s);return isNaN(f.getTime())?null:f}
function formatDrawDate(s){var d=parseDrawDate(s);if(!d)return null;var mo=['January','February','March','April','May','June','July','August','September','October','November','December'];var dy=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];return dy[d.getDay()]+', '+mo[d.getMonth()]+' '+d.getDate()+', '+d.getFullYear()}

function applyPublicSettings(s){
  if(s.lottery_name){
    LOTTERY_NAME=String(s.lottery_name).substring(0,60);
    document.title=LOTTERY_NAME;
    var p=LOTTERY_NAME.split(' ');
    var logo=document.getElementById('logoText');
    logo.textContent='';
    var prefix=document.createTextNode('ğŸ° '+(p.length>=2?p.slice(0,-1).join(' '):LOTTERY_NAME));
    logo.appendChild(prefix);
    if(p.length>=2){var sp=document.createElement('span');sp.textContent=p[p.length-1];logo.appendChild(sp);}
  }
  if(s.gcash_name){GCASH_NAME=String(s.gcash_name).substring(0,60);document.getElementById('dN').textContent=GCASH_NAME}
  if(s.gcash_number){GCASH_NUMBER=String(s.gcash_number).substring(0,20);document.getElementById('dP').textContent=GCASH_NUMBER}
  if(s.price_per_number>0){PRICE_PER=parseFloat(s.price_per_number)||1;document.getElementById('priceTag').textContent='â‚±'+PRICE_PER.toFixed(2).replace('1.00','1SO')+' PER ENTRY';document.getElementById('tagLine').textContent='Get your lucky numbers â€” only â‚±'+PRICE_PER.toFixed(2)+' each!'}
  if(s.min_quantity>0){MIN_QTY=parseInt(s.min_quantity)||100;document.getElementById('fQ').min=MIN_QTY;var ms=document.getElementById('minQtySpan');if(ms)ms.textContent=MIN_QTY}
  if(s.max_quantity>0){MAX_QTY=parseInt(s.max_quantity)||10000;document.getElementById('fQ').max=MAX_QTY}
  var fd=formatDrawDate(s.draw_date);
  if(fd){document.getElementById('drawDateText').textContent=fd;document.getElementById('drawBanner').style.display='block'}else{document.getElementById('drawBanner').style.display='none'}
  if(s.announcement&&s.announcement.trim()){document.getElementById('announceText').textContent=String(s.announcement).substring(0,500);document.getElementById('announceBanner').style.display='block'}else{document.getElementById('announceBanner').style.display='none'}
  if(s.maintenance_mode)document.getElementById('maintOverlay').classList.add('on');else document.getElementById('maintOverlay').classList.remove('on');
  calc();
}

function titleCase(s){return s.replace(/\b\w/g,c=>c.toUpperCase())}function getDigitsOnly(s){return s.replace(/\D/g,'')}function isValidPhone(s){return getDigitsOnly(s).length===11}
function updatePhoneStatus(){var r=document.getElementById('fP').value,d=getDigitsOnly(r),e=document.getElementById('phoneErr'),i=document.getElementById('fP');if(!r){e.style.display='none';i.style.borderColor='rgba(255,255,255,.1)';return}if(d.length===11){e.style.display='none';i.style.borderColor='var(--ok)'}else{e.style.display='block';e.textContent='Need 11 digits ('+d.length+'/11)';i.style.borderColor='var(--err)'}}
function setTodayDate(){document.getElementById('dateToday').textContent=new Date().toLocaleDateString('en-PH',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
function updateProgress(sold,rem){var pct=Math.max(0,Math.min(100,(rem/TOTAL_POOL)*100));var f=document.getElementById('progressFill'),t=document.getElementById('availTxt');f.style.width=pct+'%';f.classList.remove('mid','low');t.classList.remove('high','mid','low');if(pct>60){t.textContent='Plenty available';t.classList.add('high')}else if(pct>30){t.textContent='Selling fast';t.classList.add('mid');f.classList.add('mid')}else if(pct>10){t.textContent='Running low';t.classList.add('low');f.classList.add('low')}else{t.textContent=pct>0?'Almost sold out!':'Sold out';t.classList.add('low');f.classList.add('low')}}
async function checkConnection(){
  var bar=document.getElementById('connBar'),txt=document.getElementById('connTxt'),ep=document.getElementById('errPanel');
  bar.className='conn checking';txt.textContent='Connecting...';ep.classList.add('hide');
  if(SCRIPT_URL.includes('YOUR_')){bar.className='conn offline';txt.textContent='âš  Set SCRIPT_URL';return}
  // Show cached data instantly if available
  var cs=cacheGet('pub_settings'),ct=cacheGet('pub_stats');
  if(cs){applyPublicSettings(cs.data);bar.className='conn online';txt.textContent='âœ“ Connected';serverOnline=true}
  if(ct){updateProgress(ct.data.sold,ct.data.remaining)}
  // If fresh enough skip re-fetch
  if(cacheAge('pub_settings')<60000&&cacheAge('pub_stats')<60000)return;
  try{
    var[h,s,st]=await Promise.all([
      safeFetch(SCRIPT_URL+'?action=health',30000),
      safeFetch(SCRIPT_URL+'?action=publicSettings',30000),
      safeFetch(SCRIPT_URL+'?action=stats',30000)
    ]);
    if(h&&h.success){serverOnline=true;bar.className='conn online';txt.textContent='âœ“ Connected'}
    if(s&&s.success){cacheSet('pub_settings',s);applyPublicSettings(s)}
    if(st&&st.success){cacheSet('pub_stats',st);updateProgress(st.sold,st.remaining)}
  }catch(err){
    if(!serverOnline){bar.className='conn offline';
    txt.textContent='âœ— '+(err.message==='TIMEOUT'?'Timed out â€” tap Retry':err.message);
    document.getElementById('errDetail').innerHTML='<button class="retry-btn" onclick="checkConnection()">ğŸ”„ Retry</button>';
    ep.classList.remove('hide');}
  }
}
/* â˜… Quick-pick stacking */
function addQty(n){
  var cur=parseInt(document.getElementById('fQ').value)||0;
  var next=cur+n;
  if(next>MAX_QTY){
    var canAdd=MAX_QTY-cur;
    if(canAdd<=0)return toast('Already at max ('+MAX_QTY.toLocaleString()+').','warn');
    next=MAX_QTY;
    toast('Capped at max '+MAX_QTY.toLocaleString(),'warn');
  }
  document.getElementById('fQ').value=next;
  calc();
  event.currentTarget.classList.add('qp-added');
  setTimeout(()=>event.currentTarget.classList.remove('qp-added'),350);
}
function setMaxQtyFn(){
  if(parseInt(document.getElementById('fQ').value)===MAX_QTY)return toast('Already at max.','warn');
  document.getElementById('fQ').value=MAX_QTY;
  calc();
}
function resetQty(){
  document.getElementById('fQ').value='';
  calc();
}
function calc(){var v=Math.min(MAX_QTY,Math.max(0,parseInt(document.getElementById('fQ').value)||0));document.getElementById('dT').textContent='â‚± '+(v*PRICE_PER).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}
function go2(){var nm=document.getElementById('fN').value.trim(),ph=document.getElementById('fP').value.trim(),qt=parseInt(document.getElementById('fQ').value);if(!nm||nm.length<2)return toast('Enter full name.','err');if(!isValidPhone(ph))return toast('Phone must be 11 digits.','err');if(!qt||qt<MIN_QTY){document.getElementById('fQ').value=MIN_QTY;calc();return toast('Min '+MIN_QTY+'.','err')}if(qt>MAX_QTY){document.getElementById('fQ').value=MAX_QTY;calc();return toast('Max '+MAX_QTY.toLocaleString()+'.','err')}hide('p1');show('p2');document.getElementById('dA').textContent=' â‚± '+(qt*PRICE_PER).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});stpSet(2)}
function go1(){hide('p2');show('p1');stpSet(1)}
function stpSet(n){var c=(id,cl)=>document.getElementById(id).className=cl;c('i1',n===1?'stp on':'stp ok');c('i2',n===2?'stp on':n>2?'stp ok':'stp');c('i3',n===3?'stp on':'stp');c('l1',n>=2?'sln on':'sln');c('l2',n>=3?'sln on':'sln')}
function submitPurchase(){
  var ref=document.getElementById('fR').value.trim();
  if(!ref)return toast('Enter GCash ref.','err');
  if(!/^\d{1,13}$/.test(ref))return toast('GCash ref must be digits only (max 13).','err');
  if(!serverOnline){toast('Offline.','err');checkConnection();return}
  // Re-validate everything â€” prevents DOM manipulation between steps
  var nm=document.getElementById('fN').value.trim(),ph=document.getElementById('fP').value.trim(),qt=parseInt(document.getElementById('fQ').value);
  if(!nm||nm.length<2)return toast('Invalid name.','err');
  if(!isValidPhone(ph))return toast('Invalid phone.','err');
  if(!qt||qt<MIN_QTY||qt>MAX_QTY)return toast('Invalid quantity.','err');
  document.getElementById('buyBtn').disabled=true;
  attemptPurchase(nm,ph,qt,ref,0)
}
async function attemptPurchase(nm,ph,qt,ref,tryN){var rb=document.getElementById('rb'),rf=document.getElementById('rf');if(tryN===0){showOv('Generating '+qt.toLocaleString()+' numbers...','');rb.style.display='none'}else{showOv('Retry '+tryN+'/'+MAX_RETRY,'');rb.style.display='block';rf.style.transition='none';rf.style.width='0%';setTimeout(()=>{rf.style.transition='width '+(RETRY_MS[tryN-1]/1000)+'s linear';rf.style.width='100%'},50)}if(tryN>0)await new Promise(r=>setTimeout(r,RETRY_MS[tryN-1]));try{var d=await safeFetch(SCRIPT_URL+'?'+new URLSearchParams({action:'purchase',quantity:qt,name:nm,phone:ph,gcashRef:ref}),FETCH_TIMEOUT);if(d.success){hideOv();document.getElementById('buyBtn').disabled=false;myNums=d.numbers.map(n=>pad6(n));showResult(d,nm,ph,qt,ref);toast('â³ '+d.quantity.toLocaleString()+' numbers reserved â€” pending approval!','warn')}else if(d.retryable&&tryN<MAX_RETRY){toast('Retrying...','warn');attemptPurchase(nm,ph,qt,ref,tryN+1)}else{hideOv();document.getElementById('buyBtn').disabled=false;toast(d.error||'Failed.','err')}}catch(err){if(tryN<MAX_RETRY){toast('Retrying...','warn');attemptPurchase(nm,ph,qt,ref,tryN+1)}else{hideOv();document.getElementById('buyBtn').disabled=false;toast(getFriendlyError(err).short,'err')}}}
function censorName(n){var p=n.trim().split(/\s+/);return p.map(function(w,i){return i===0?w:w.charAt(0)+'***'}).join(' ')}
function censorPhone(p){return p.substring(0,5)+'******'}
function showResult(d,nm,ph,qt,ref){hide('secB');show('secR');stpSet(3);document.getElementById('rI').textContent=d.transactionId;document.getElementById('rD').textContent=d.timestamp;document.getElementById('rN').textContent=censorName(nm);document.getElementById('rP').textContent=censorPhone(ph);document.getElementById('rQ').textContent=d.quantity.toLocaleString();document.getElementById('rA').textContent='â‚± '+Number(d.amount).toLocaleString(undefined,{minimumFractionDigits:2});document.getElementById('rR').textContent=ref;document.getElementById('rS').textContent='â³ PENDING';document.getElementById('rC').textContent=myNums.length.toLocaleString();var h='';for(var i=0;i<myNums.length;i++)h+='<div class="ni">'+myNums[i]+'</div>';document.getElementById('nG').innerHTML=h;scrollTo({top:0,behavior:'smooth'})}
function cpA(){navigator.clipboard.writeText(myNums.join('\n')).then(()=>toast('Copied!','suc')).catch(()=>toast('Copy failed','err'))}
function dlA(){var tx=document.getElementById('rI').textContent,L=[LOTTERY_NAME,'TX: '+tx,'Date: '+document.getElementById('rD').textContent,'Name: '+document.getElementById('rN').textContent,'GCash Ref: '+document.getElementById('rR').textContent,'Status: PENDING APPROVAL','Qty: '+myNums.length,'Amount: '+document.getElementById('rA').textContent,'','NUMBERS:',''];for(var i=0;i<myNums.length;i++)L.push(myNums[i]);var b=new Blob([L.join('\n')],{type:'text/plain'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='Lucky6-'+tx+'.txt';a.click();toast('Downloaded!','suc')}
function esc(s){return String(s).replace(/[&<>"']/g,function(c){return{'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]})}
function prA(){var w=window.open('');var tx=esc(document.getElementById('rI').textContent),ref=esc(document.getElementById('rR').textContent),amt=esc(document.getElementById('rA').textContent),lname=esc(LOTTERY_NAME);var nums=myNums.map(n=>'<div class="n">'+esc(n)+'</div>').join('');w.document.write('<!DOCTYPE html><html><head><title>'+lname+'</title><style>body{font-family:monospace;padding:20px;font-size:12px}.g{display:grid;grid-template-columns:repeat(6,1fr);gap:3px}.n{border:1px solid #ddd;padding:5px;text-align:center;font-weight:bold;letter-spacing:2px}.pending{background:#fff3e0;border:2px solid #ff9800;padding:10px;margin:10px 0;text-align:center;font-weight:bold;border-radius:6px}.hi{background:#fffde7;border:2px solid #ffd700;padding:8px 14px;margin:6px 0;border-radius:6px;font-family:monospace;font-size:14px;font-weight:bold}</style></head><body><h1 style="text-align:center">'+lname+'</h1><div class="pending">â³ STATUS: PENDING APPROVAL</div><div class="hi">TX: '+tx+'</div><div class="hi">GCash Ref: '+ref+'</div><p>Qty: '+esc(String(myNums.length))+' | '+amt+'</p><div class="g">'+nums+'</div></body></html>');w.document.close();setTimeout(()=>w.print(),300)}
function cpGC(){navigator.clipboard.writeText(GCASH_NUMBER.replace(/\D/g,'')).then(()=>toast('Copied!','suc')).catch(()=>{})}
function again(){hide('secR');show('secB');['fN','fP','fQ','fR'].forEach(id=>document.getElementById(id).value='');document.getElementById('dT').textContent='â‚± 0.00';document.getElementById('phoneErr').style.display='none';document.getElementById('fP').style.borderColor='rgba(255,255,255,.1)';hide('p2');show('p1');stpSet(1);myNums=[];scrollTo({top:0,behavior:'smooth'})}

/* â•â•â• ADMIN â•â•â• */
async function adminApi(a,p){p=p||{};p.action=a;p.token=TOKEN;var c=new AbortController(),t=setTimeout(()=>c.abort(),60000);try{var r=await fetch(SCRIPT_URL+'?'+new URLSearchParams(p),{signal:c.signal,redirect:'follow'});clearTimeout(t);var txt=await r.text();try{return JSON.parse(txt)}catch(e){var m=txt.match(/\{[\s\S]*\}/);if(m)return JSON.parse(m[0]);throw new Error('Parse error')}}catch(err){clearTimeout(t);if(err.name==='AbortError')throw new Error('Timeout');throw err}}

async function doLogin(){var u=document.getElementById('loginUser').value.trim(),p=document.getElementById('loginPass').value.trim();if(!u||!p)return toast('Enter credentials.','err');document.getElementById('loginBtn').disabled=true;showOv('Signing in...','');try{var d=await adminApi('adminLogin',{username:u,password:p});if(d.success){TOKEN=d.token;document.getElementById('adminUser').textContent=u;document.getElementById('adminLogin').style.display='none';document.getElementById('adminPanel').style.display='block';loadDashboard();startAutoRefresh();toast('Welcome!','suc');
  // Pre-fetch all pages in background for instant switching
  setTimeout(()=>{
    adminApi('adminTransactions',{page:1,perPage:30}).then(r=>{if(r&&r.success)cacheSet('admin_tx_1',r)}).catch(()=>{});
    adminApi('adminSoldNumbers',{page:1,perPage:100}).then(r=>{if(r&&r.success)cacheSet('admin_num_1',r)}).catch(()=>{});
    adminApi('adminGetSettings').then(r=>{if(r&&r.success)cacheSet('admin_set',r.settings)}).catch(()=>{});
  },500);
}else toast(d.error,'err')}catch(e){toast(e.message,'err')}hideOv();document.getElementById('loginBtn').disabled=false}
function doLogout(){TOKEN='';cacheClear();document.getElementById('adminPanel').style.display='none';document.getElementById('adminLogin').style.display='flex';document.getElementById('loginUser').value='';document.getElementById('loginPass').value='';if(_art)clearInterval(_art);toast('Logged out.','warn')}
var activeP='dashboard',_art=null;
function goPage(n){activeP=n;document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById('pg-'+n).classList.add('active');document.querySelectorAll('.sidebar .nav-item').forEach(x=>x.classList.remove('active'));document.querySelectorAll('[data-page="'+n+'"]').forEach(x=>x.classList.add('active'));document.querySelectorAll('.mob-nav .nav-item').forEach(x=>{x.classList.remove('active');if(x.textContent.toLowerCase().includes(n.substring(0,4)))x.classList.add('active')});if(n==='dashboard')loadDashboard();if(n==='transactions')loadTransactions();if(n==='numbers')loadNumbers();if(n==='settings')loadSettingsFn()}
function statusClass(st){if(st==='APPROVED')return'ok';if(st==='PENDING')return'pend';if(st==='DECLINED')return'dec';return'fail'}

async function loadDashboard(){await swr('admin_dash',async()=>await adminApi('adminDashboard'),d=>{if(!d||!d.success)return;document.getElementById('dsSold').textContent=d.totalSold.toLocaleString();document.getElementById('dsRemain').textContent=d.remaining.toLocaleString();document.getElementById('dsPct').textContent=d.percentSold+'% sold';document.getElementById('dsRevenue').textContent='â‚±'+d.totalRevenue.toLocaleString();document.getElementById('dsPending').textContent=d.pendingTransactions.toLocaleString();document.getElementById('dsApproved').textContent=d.approvedTransactions.toLocaleString();document.getElementById('dsDeclined').textContent=d.declinedTransactions.toLocaleString();document.getElementById('dsBuyers').textContent=d.uniqueBuyers.toLocaleString();var pct=d.totalSold/d.totalPool*100;var bar=document.getElementById('dsBar');bar.style.width=pct+'%';bar.classList.remove('mid','low');if(pct>70)bar.classList.add('low');else if(pct>40)bar.classList.add('mid');var list=document.getElementById('feedList');var acts=d.recentActivity||[];if(!acts.length){list.innerHTML='<li class="tbl-empty">No activity.</li>';return}var h='';acts.forEach(a=>{var dc=statusClass(a.status);var txE=esc(a.transactionId),nmE=esc(a.name),stE=esc(a.status);h+='<li style="cursor:pointer;align-items:flex-start" onclick="openTxDetail(\''+txE+'\')"><div class="dot '+dc+'" style="margin-top:4px;flex-shrink:0"></div><div style="flex:1;min-width:0"><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:6px"><strong style="word-break:break-word">'+nmE+'</strong><span class="badge '+dc+'" style="flex-shrink:0;margin-left:4px">'+stE+'</span></div><div style="font-size:.8rem;color:var(--sub);margin-top:2px">'+esc(String(a.quantity))+' entries Â· â‚±'+Number(a.amount).toLocaleString()+'</div><span class="time" style="display:block;margin-top:2px">'+esc(a.timestamp)+'<br>'+txE+'</span></div></li>'});list.innerHTML=h})}

function buildTxActions(status,txId){
  var a='<div class="tx-actions">';
  if(status==='PENDING')a+=
    '<button class="btn-sm btn-green" onclick="event.stopPropagation();confirmApprove(\''+txId+'\')">Approve</button>'+
    '<button class="btn-sm btn-red" onclick="event.stopPropagation();confirmDecline(\''+txId+'\')">Decline</button>';
  a+='<button class="btn-sm btn-orange" onclick="event.stopPropagation();confirmDelete(\''+txId+'\')">Delete</button></div>';
  return a;
}

async function loadTransactions(pg){if(pg)currentPage.tx=pg;await swr('admin_tx_'+currentPage.tx,async()=>{var d=await adminApi('adminTransactions',{page:currentPage.tx,perPage:30});return d.success?d:null},d=>{if(!d)return;var b=document.getElementById('txBody');if(!d.transactions.length){b.innerHTML='<tr><td colspan="9" class="tbl-empty">None.</td></tr>';document.getElementById('txPagination').innerHTML='';return}var h='';d.transactions.forEach(t=>{var sc=statusClass(t.status),txE=esc(t.transactionId);h+='<tr data-tx="'+txE+'" class="clickable-row" onclick="openTxDetail(\''+txE+'\')"><td>'+esc(t.timestamp)+'</td><td class="mono" style="font-size:.73rem">'+txE+'</td><td>'+esc(t.name)+'</td><td>'+esc(t.phone)+'</td><td>'+esc(t.gcashRef)+'</td><td>'+esc(String(t.quantity))+'</td><td>â‚±'+Number(t.amount).toLocaleString()+'</td><td><span class="badge '+sc+'">'+esc(t.status)+'</span></td><td>'+buildTxActions(t.status,txE)+'</td></tr>'});b.innerHTML=h;renderPg('txPagination',d.page,d.totalPages,'loadTransactions')})};

async function loadNumbers(pg){if(pg)currentPage.num=pg;await swr('admin_num_'+currentPage.num,async()=>{var d=await adminApi('adminSoldNumbers',{page:currentPage.num,perPage:100});return d.success?d:null},d=>{if(!d)return;var b=document.getElementById('numBody');if(!d.numbers.length){b.innerHTML='<tr><td colspan="6" class="tbl-empty">None.</td></tr>';document.getElementById('numPagination').innerHTML='';return}var h='';d.numbers.forEach(n=>{var txE=esc(n.transactionId);h+='<tr class="clickable-row" onclick="openTxDetail(\''+txE+'\')"><td class="mono">'+esc(n.number)+'</td><td style="font-size:.73rem">'+txE+'</td><td>'+esc(n.name)+'</td><td>'+esc(n.phone)+'</td><td>'+esc(n.gcashRef)+'</td><td>'+esc(n.timestamp)+'</td></tr>'});b.innerHTML=h;renderPg('numPagination',d.page,d.totalPages,'loadNumbers')})}

function renderPg(cid,cur,tot,fn){var c=document.getElementById(cid);if(tot<=1){c.innerHTML='';return}var h='<button class="pg-btn" onclick="'+fn+'('+(cur-1)+')" '+(cur<=1?'disabled':'')+'>â†</button>';var s=Math.max(1,cur-2),e=Math.min(tot,cur+2);if(s>1)h+='<button class="pg-btn" onclick="'+fn+'(1)">1</button>';if(s>2)h+='<span class="pg-info">â€¦</span>';for(var i=s;i<=e;i++)h+='<button class="pg-btn'+(i===cur?' active':'')+'" onclick="'+fn+'('+i+')">'+i+'</button>';if(e<tot-1)h+='<span class="pg-info">â€¦</span>';if(e<tot)h+='<button class="pg-btn" onclick="'+fn+'('+tot+')">'+tot+'</button>';h+='<button class="pg-btn" onclick="'+fn+'('+(cur+1)+')" '+(cur>=tot?'disabled':'')+'>â†’</button> <span class="pg-info">'+cur+'/'+tot+'</span>';c.innerHTML=h}

async function openTxDetail(txId){
  showOv('Loading details...','');
  try{
    var d=await adminApi('adminGetTransaction',{transactionId:txId});
    hideOv();
    if(!d.success){toast(d.error||'Not found','err');return}
    var tx=d.transaction;
    _detailTx=tx;
    document.getElementById('detailTitle').innerHTML='ğŸ“‹ Transaction Detail';
    document.getElementById('detailSub').textContent=tx.transactionId;
    var g='';
    g+='<div class="ri"><div class="rl">Transaction ID</div><div class="rv" style="font-family:JetBrains Mono,monospace;color:var(--gold)">'+tx.transactionId+'</div></div>';
    g+='<div class="ri"><div class="rl">Date</div><div class="rv">'+tx.timestamp+'</div></div>';
    g+='<div class="ri"><div class="rl">Name</div><div class="rv">'+tx.name+'</div></div>';
    g+='<div class="ri"><div class="rl">Phone</div><div class="rv">'+tx.phone+'</div></div>';
    g+='<div class="ri"><div class="rl">GCash Ref</div><div class="rv">'+tx.gcashRef+'</div></div>';
    g+='<div class="ri"><div class="rl">Quantity</div><div class="rv">'+Number(tx.quantity).toLocaleString()+'</div></div>';
    g+='<div class="ri"><div class="rl">Amount</div><div class="rv" style="color:var(--gold);font-weight:800">â‚±'+Number(tx.amount).toLocaleString()+'</div></div>';
    g+='<div class="ri"><div class="rl">Status</div><div class="rv"><span class="badge '+statusClass(tx.status)+'">'+tx.status+'</span></div></div>';
    document.getElementById('detailGrid').innerHTML=g;
    var allNums=[];
    var nh='';
    if(tx.soldNumbers&&tx.soldNumbers.length>0){
      allNums=tx.soldNumbers;
      nh+='<h3>ğŸ° Numbers ('+tx.soldCount.toLocaleString()+' in registry)</h3>';
      nh+='<div class="nbox" style="max-height:300px"><div class="ngrid">';
      tx.soldNumbers.forEach(n=>{nh+='<div class="ni">'+n+'</div>'});
      nh+='</div></div>';
    }else if(tx.numbers&&tx.numbers.trim()){
      var nums=tx.numbers.split(',').map(n=>n.trim()).filter(n=>n);
      allNums=nums.map(n=>pad6(n));
      nh+='<h3>ğŸ° Numbers ('+nums.length.toLocaleString()+' from log)</h3>';
      if(tx.status==='DECLINED')nh+='<div style="font-size:.78rem;color:var(--err);margin-bottom:8px">âš ï¸ Numbers were freed (declined)</div>';
      nh+='<div class="nbox" style="max-height:300px"><div class="ngrid">';
      var showN=nums.slice(0,500);
      showN.forEach(n=>{nh+='<div class="ni" style="opacity:'+(tx.status==='DECLINED'?'.4':'1')+'">'+pad6(n)+'</div>'});
      if(nums.length>500)nh+='<div style="text-align:center;padding:10px;color:var(--sub)">...and '+(nums.length-500).toLocaleString()+' more</div>';
      nh+='</div></div>';
    }else{
      nh+='<h3>ğŸ° Numbers</h3><div style="color:var(--sub);font-size:.85rem;padding:10px">No numbers data available.</div>';
    }
    _detailTx._allNums=allNums;
    document.getElementById('detailNums').innerHTML=nh;
    var ah='';
    if(allNums.length>0){
      ah+='<button class="btn-sm btn-blue" onclick="copyDetailNums()">ğŸ“‹ Copy All Numbers</button>';
      ah+='<button class="btn-sm btn-green" onclick="downloadDetailTx()">â¬‡ Download TXT</button>';
    }
    ah+='<button class="btn-sm btn-blue" onclick="closeDetail()" style="margin-left:4px">Close</button>';
    document.getElementById('detailActions').innerHTML=ah;
    document.getElementById('detailModal').classList.add('on');
  }catch(e){hideOv();toast('Error: '+e.message,'err')}
}

function copyDetailNums(){if(!_detailTx||!_detailTx._allNums||!_detailTx._allNums.length)return toast('No numbers','err');navigator.clipboard.writeText(_detailTx._allNums.join('\n')).then(()=>toast('ğŸ“‹ Copied '+_detailTx._allNums.length.toLocaleString()+' numbers!','suc')).catch(()=>toast('Copy failed','err'))}
function downloadDetailTx(){if(!_detailTx)return;var tx=_detailTx;var nums=tx._allNums||[];var L=[LOTTERY_NAME,'','TX: '+tx.transactionId,'Date: '+tx.timestamp,'Name: '+tx.name,'Phone: '+tx.phone,'GCash Ref: '+tx.gcashRef,'Status: '+tx.status,'Qty: '+tx.quantity,'Amount: â‚±'+Number(tx.amount).toLocaleString(),'','NUMBERS ('+nums.length+'):',''];nums.forEach(n=>L.push(n));var b=new Blob([L.join('\n')],{type:'text/plain'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='Lucky6-'+tx.transactionId+'.txt';a.click();toast('â¬‡ Downloaded!','suc')}

function confirmApprove(tx){document.getElementById('confirmTitle').textContent='âœ… Approve Transaction?';document.getElementById('confirmMsg').innerHTML='Approve <code>'+tx+'</code>?<br>This confirms payment has been verified.';document.getElementById('confirmYes').textContent='Approve';document.getElementById('confirmYes').className='btn-sm btn-green';document.getElementById('confirmYes').onclick=()=>doApprove(tx);document.getElementById('confirmModal').classList.add('on')}
async function doApprove(tx){closeConfirm();toast('Approving...','warn');cacheClear('admin_');try{var d=await adminApi('adminApproveTransaction',{transactionId:tx});if(d.success){toast('âœ… '+d.message,'suc');loadDashboard();loadTransactions()}else{toast(d.error,'err');loadTransactions()}}catch(e){toast('Failed','err');loadTransactions()}}
function confirmDecline(tx){document.getElementById('confirmTitle').textContent='âŒ Decline Transaction?';document.getElementById('confirmMsg').innerHTML='Decline <code>'+tx+'</code>?<br>This will free up the reserved numbers.<br>The log entry stays as "DECLINED".';document.getElementById('confirmYes').textContent='Decline';document.getElementById('confirmYes').className='btn-sm btn-red';document.getElementById('confirmYes').onclick=()=>doDecline(tx);document.getElementById('confirmModal').classList.add('on')}
async function doDecline(tx){closeConfirm();toast('Declining...','warn');cacheClear('admin_');try{var d=await adminApi('adminDeclineTransaction',{transactionId:tx});if(d.success){toast('âŒ '+d.message,'suc');loadDashboard();loadTransactions()}else{toast(d.error,'err');loadTransactions()}}catch(e){toast('Failed','err');loadTransactions()}}
function confirmDelete(tx){document.getElementById('confirmTitle').textContent='ğŸ—‘ï¸ Permanently Delete?';document.getElementById('confirmMsg').innerHTML='Completely erase <code>'+tx+'</code> from ALL sheets.<br>Numbers + transaction log = permanently gone.<br><strong>This cannot be undone!</strong>';document.getElementById('confirmYes').textContent='Delete Forever';document.getElementById('confirmYes').className='btn-sm btn-orange';document.getElementById('confirmYes').onclick=()=>doDelete(tx);document.getElementById('confirmModal').classList.add('on')}
async function doDelete(tx){closeConfirm();var row=document.querySelector('tr[data-tx="'+tx+'"]');if(row){row.classList.add('row-deleting');setTimeout(()=>row.remove(),400)}toast('Deleting...','warn');cacheClear('admin_');try{var d=await adminApi('adminDeleteTransaction',{transactionId:tx});if(d.success){toast('ğŸ—‘ï¸ '+d.message,'suc');loadDashboard();loadTransactions()}else{toast(d.error,'err');loadTransactions()}}catch(e){toast('Failed','err');loadTransactions()}}
function confirmDeleteAll(){document.getElementById('confirmTitle').textContent='ğŸ—‘ï¸ Delete ALL Transactions?';document.getElementById('confirmMsg').innerHTML='This will permanently erase <strong>every transaction and all sold numbers</strong> from the sheet.<br><br><strong style="color:var(--err)">This cannot be undone!</strong>';document.getElementById('confirmYes').textContent='Delete Everything';document.getElementById('confirmYes').className='btn-sm btn-red';document.getElementById('confirmYes').onclick=()=>doDeleteAll();document.getElementById('confirmModal').classList.add('on')}
async function doDeleteAll(){closeConfirm();showOv('Deleting all transactions...','');cacheClear('admin_');try{var d=await adminApi('adminDeleteAllTransactions');hideOv();if(d.success){toast('ğŸ—‘ï¸ All transactions deleted.','suc');loadDashboard();loadTransactions()}else{toast(d.error||'Failed.','err')}}catch(e){hideOv();toast('Error: '+e.message,'err')}}

async function searchNumber(){var q=document.getElementById('searchNum').value.trim();if(!q)return toast('Enter number.','err');showOv('Searching...','');try{var d=await adminApi('adminSearchNumber',{query:q});hideOv();document.getElementById('searchResults').style.display='block';document.getElementById('searchTitle').textContent=d.found?'âœ… '+d.query+' found â€” click to view details':'âŒ Not found';if(d.found){document.getElementById('searchThead').innerHTML='<tr><th>Number</th><th>TX</th><th>Name</th><th>Phone</th><th>GCash</th><th>Date</th></tr>';var h='';d.results.forEach(r=>{var txE=esc(r.transactionId);h+='<tr class="clickable-row" onclick="openTxDetail(\''+txE+'\')"><td class="mono">'+esc(r.number)+'</td><td>'+txE+'</td><td>'+esc(r.name)+'</td><td>'+esc(r.phone)+'</td><td>'+esc(r.gcashRef)+'</td><td>'+esc(r.timestamp)+'</td></tr>'});document.getElementById('searchTbody').innerHTML=h}else{document.getElementById('searchThead').innerHTML='';document.getElementById('searchTbody').innerHTML='<tr><td class="tbl-empty">Not sold.</td></tr>'}}catch(e){hideOv();toast('Error','err')}}
async function searchBuyerFn(){var q=document.getElementById('searchBuyer').value.trim();if(!q)return toast('Enter term.','err');showOv('Searching...','');try{var d=await adminApi('adminSearchBuyer',{query:q});hideOv();document.getElementById('searchResults').style.display='block';document.getElementById('searchTitle').textContent=d.total+' result(s) â€” click to view details';if(d.total>0){document.getElementById('searchThead').innerHTML='<tr><th>Date</th><th>TX</th><th>Name</th><th>Phone</th><th>Qty</th><th>Amt</th><th>Status</th></tr>';var h='';d.results.forEach(r=>{var sc=statusClass(r.status),txE=esc(r.transactionId);h+='<tr class="clickable-row" onclick="openTxDetail(\''+txE+'\')"><td>'+esc(r.timestamp)+'</td><td>'+txE+'</td><td>'+esc(r.name)+'</td><td>'+esc(r.phone)+'</td><td>'+esc(String(r.quantity))+'</td><td>â‚±'+Number(r.amount).toLocaleString()+'</td><td><span class="badge '+sc+'">'+esc(r.status)+'</span></td></tr>'});document.getElementById('searchTbody').innerHTML=h}else{document.getElementById('searchThead').innerHTML='';document.getElementById('searchTbody').innerHTML='<tr><td class="tbl-empty">None.</td></tr>'}}catch(e){hideOv();toast('Error','err')}}
async function addNumber(){var num=document.getElementById('addNum').value.trim();if(!num)return toast('Enter number.','err');showOv('Adding...','');try{var d=await adminApi('adminAddNumber',{number:num,name:document.getElementById('addName').value.trim()||'ADMIN',phone:document.getElementById('addPhone').value.trim()||'N/A'});hideOv();if(d.success){toast(d.message,'suc');['addNum','addName','addPhone'].forEach(id=>document.getElementById(id).value='');cacheClear('admin_')}else toast(d.error,'err')}catch(e){hideOv();toast('Error','err')}}
async function removeNumber(){var num=document.getElementById('removeNum').value.trim();if(!num)return toast('Enter number.','err');document.getElementById('confirmTitle').textContent='Remove?';document.getElementById('confirmMsg').innerHTML='Remove <code>'+num.padStart(6,'0')+'</code>?';document.getElementById('confirmYes').textContent='Remove';document.getElementById('confirmYes').className='btn-sm btn-red';document.getElementById('confirmYes').onclick=async()=>{closeConfirm();showOv('Removing...','');try{var d=await adminApi('adminRemoveNumber',{number:num});hideOv();if(d.success){toast(d.message,'suc');document.getElementById('removeNum').value='';cacheClear('admin_')}else toast(d.error,'err')}catch(e){hideOv();toast('Error','err')}};document.getElementById('confirmModal').classList.add('on')}

async function loadSettingsFn(){
  await swr('admin_set',async()=>{var d=await adminApi('adminGetSettings');return d.success?d.settings:null},s=>{
    if(!s)return;
    document.getElementById('setGcashName').value=s.gcash_name||'';
    document.getElementById('setGcashNum').value=s.gcash_number||'';
    document.getElementById('setLotteryName').value=s.lottery_name||'';
    document.getElementById('setDrawDate').value=s.draw_date||'';
    document.getElementById('setPrice').value=s.price_per_number||'1';
    document.getElementById('setMinQty').value=s.min_quantity||'50';
    document.getElementById('setMaxQty').value=s.max_quantity||'10000';
    document.getElementById('setAnnouncement').value=s.announcement||'';
    document.getElementById('setMaintenance').value=s.maintenance_mode||'false';
  });
}

async function saveSettings(){
  var np=document.getElementById('setNewPass').value,np2=document.getElementById('setNewPass2').value;
  if(np&&np.length<6)return toast('Min 6 chars.','err');
  if(np&&np!==np2)return toast('No match.','err');
  showOv('Saving...','');
  var p={gcash_name:document.getElementById('setGcashName').value.trim(),gcash_number:document.getElementById('setGcashNum').value.trim(),lottery_name:document.getElementById('setLotteryName').value.trim(),draw_date:document.getElementById('setDrawDate').value,price_per_number:document.getElementById('setPrice').value,min_quantity:document.getElementById('setMinQty').value,max_quantity:document.getElementById('setMaxQty').value,announcement:document.getElementById('setAnnouncement').value.trim(),maintenance_mode:document.getElementById('setMaintenance').value};
  if(np)p.new_password=np;
  try{var d=await adminApi('adminUpdateSettings',p);hideOv();if(d.success){toast('âœ… Saved!','suc');cacheClear();document.getElementById('setNewPass').value='';document.getElementById('setNewPass2').value='';if(np){toast('Password changed.','warn');setTimeout(doLogout,2000)}}else toast(d.error,'err')}catch(e){hideOv();toast('Error','err')}
}

async function exportData(type){showOv('Exporting...','');try{var d=await adminApi('adminExportData',{type});hideOv();if(!d.success)return toast(d.error,'err');var csv=d.headers.join(',')+'\n';d.data.forEach(r=>{csv+=r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')+'\n'});var b=new Blob([csv],{type:'text/csv'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='Lucky6-'+type+'-'+new Date().toISOString().slice(0,10)+'.csv';a.click();toast('Exported '+(d.total||0)+' rows!','suc')}catch(e){hideOv();toast('Error','err')}}

function startAutoRefresh(){if(_art)clearInterval(_art);_art=setInterval(()=>{if(!TOKEN)return;if(activeP==='dashboard'&&cacheAge('admin_dash')>=SRV_MS)adminApi('adminDashboard').then(d=>{if(d&&d.success){cacheSet('admin_dash',d);if(activeP==='dashboard'){document.getElementById('dsSold').textContent=d.totalSold.toLocaleString();document.getElementById('dsRemain').textContent=d.remaining.toLocaleString();document.getElementById('dsRevenue').textContent='â‚±'+d.totalRevenue.toLocaleString();document.getElementById('dsPending').textContent=d.pendingTransactions.toLocaleString();document.getElementById('dsApproved').textContent=d.approvedTransactions.toLocaleString();document.getElementById('dsDeclined').textContent=d.declinedTransactions.toLocaleString()}}}).catch(()=>{})},UI_MS)}

document.addEventListener('DOMContentLoaded',async()=>{
  detectMode();
  if(IS_ADMIN_MODE){
    document.getElementById('loginPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});document.getElementById('loginUser').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('loginPass').focus()})
  }else{
    setTodayDate();document.getElementById('dP').textContent=GCASH_NUMBER;document.getElementById('dN').textContent=GCASH_NAME;
    var ni=document.getElementById('fN');ni.addEventListener('input',()=>{var p=ni.selectionStart;ni.value=titleCase(ni.value);ni.setSelectionRange(p,p)});
    var pi=document.getElementById('fP');pi.addEventListener('input',()=>{pi.value=getDigitsOnly(pi.value).substring(0,11);updatePhoneStatus()});pi.addEventListener('blur',updatePhoneStatus);
    var qi=document.getElementById('fQ');
    qi.addEventListener('input',function(){calc()});
    qi.addEventListener('blur',function(){var v=parseInt(qi.value);if(!isNaN(v)&&v<MIN_QTY&&qi.value!==''){qi.value=MIN_QTY;toast('Min '+MIN_QTY,'warn')}if(!isNaN(v)&&v>MAX_QTY){qi.value=MAX_QTY;toast('Max '+MAX_QTY.toLocaleString(),'warn')}calc()});
    checkConnection();setInterval(setTodayDate,60000)
  }
});
</script>
</body>
</html>
