<script>
const SCRIPT_URL='https://script.google.com/macros/s/AKfycbzRtzMSCdBGuWNxvT8b6qwNtdSfqUc0_4C5-RsiNHEfciFzoEvUqxombz4O8XQ9qS73Bg/exec';
const ADMIN_SECRET='admin';
let GCASH_NUMBER='0917-123-4567',GCASH_NAME='Juan Dela Cruz',PRICE_PER=1,MIN_QTY=100,MAX_QTY=10000,LOTTERY_NAME='PISO PALARO';
const MAX_RETRY=3,RETRY_MS=[3000,5000,8000],FETCH_TIMEOUT=60000,TOTAL_POOL=200000;
const MAX_NAME_LENGTH=40;
let myNums=[],serverOnline=false,TOKEN='';
let currentPage={tx:1,num:1},IS_ADMIN_MODE=false;
let _detailTx=null,_initData=null;

/* ‚îÄ‚îÄ Frontend cache (memory + sessionStorage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const CACHE={};
function cacheSet(k,d){CACHE[k]={data:d,time:Date.now()};try{sessionStorage.setItem('pp_'+k,JSON.stringify({data:d,time:Date.now()}))}catch(e){}}
function cacheGet(k){if(CACHE[k])return CACHE[k];try{var s=sessionStorage.getItem('pp_'+k);if(s){var p=JSON.parse(s);CACHE[k]=p;return p}}catch(e){}return null}
function cacheAge(k){var c=cacheGet(k);return c?Date.now()-c.time:Infinity}
function cacheClear(p){Object.keys(CACHE).forEach(k=>{if(!p||k.startsWith(p))delete CACHE[k]});try{Object.keys(sessionStorage).forEach(k=>{if(k.startsWith('pp_')&&(!p||k.startsWith('pp_'+p)))sessionStorage.removeItem(k)})}catch(e){}}

/* ‚îÄ‚îÄ TX detail frontend cache ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const _txCache={};
function txCacheGet(id){return _txCache[id]||null;}
function txCacheSet(id,d){_txCache[id]=d;}
function txCacheInvalidate(id){if(id)delete _txCache[id];else Object.keys(_txCache).forEach(k=>delete _txCache[k]);}

/* ‚îÄ‚îÄ SWR: render instantly from cache, refresh behind scenes */
async function swr(ck,fn,render){
  var c=cacheGet(ck);
  if(c)render(c.data);
  if(cacheAge(ck)<3000)return c?c.data:null;
  try{var f=await fn();if(f){cacheSet(ck,f);render(f)}return f}catch(e){if(!c)throw e;return c.data}
}

function pad6(n){return String(n).padStart(6,'0').substring(0,6)}
function esc(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
function detectMode(){if(new URLSearchParams(location.search).get('access')===ADMIN_SECRET){IS_ADMIN_MODE=true;document.getElementById('publicPage').style.display='none';document.getElementById('adminPage').style.display='block';document.title='Admin'}else{document.getElementById('publicPage').style.display='block';document.getElementById('adminPage').style.display='none'}}
function toast(m,t){var e=document.getElementById('toast');e.textContent=m;e.className='toast '+t+' on';clearTimeout(e._t);e._t=setTimeout(()=>e.classList.remove('on'),4000)}
function showOv(t,s){document.getElementById('ovT').textContent=t||'';document.getElementById('ovS').textContent=s||'';document.getElementById('ov').classList.add('on')}
function hideOv(){document.getElementById('ov').classList.remove('on')}
function closeConfirm(){document.getElementById('confirmModal').classList.remove('on')}
function closeDetail(){document.getElementById('detailModal').classList.remove('on');_detailTx=null}
function show(id){document.getElementById(id).classList.remove('hide')}
function hide(id){document.getElementById(id).classList.add('hide')}
function goToPublicPage(){window.open(location.href.split('?')[0],'_blank')}
function cpField(id){var txt=document.getElementById(id).textContent;navigator.clipboard.writeText(txt).then(()=>toast('üìã Copied: '+txt,'suc')).catch(()=>toast('Copy failed','err'))}

// ‚îÄ‚îÄ Sanitize on frontend too (defense in depth) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sanitizeInput(str,maxLen){
  str=String(str||'').trim();
  str=str.replace(/<[^>]*>/g,'');
  str=str.replace(/[<>"'`;{}()\\]/g,'');
  str=str.replace(/[\x00-\x1F\x7F]/g,'');
  if(maxLen)str=str.substring(0,maxLen);
  return str;
}

async function safeFetch(url,ms){
  var c=new AbortController(),t=setTimeout(()=>c.abort(),ms||FETCH_TIMEOUT);
  try{
    var r=await fetch(url,{redirect:'follow',signal:c.signal});clearTimeout(t);
    var txt=await r.text();
    if(txt.trim().startsWith('<!DOCTYPE'))throw new Error(txt.includes('accounts.google.com')?'AUTH_ERROR':'HTML_RESPONSE');
    try{return JSON.parse(txt)}catch(e){var m=txt.match(/\{[\s\S]*\}/);if(m)return JSON.parse(m[0]);throw new Error('PARSE_ERROR')}
  }catch(err){clearTimeout(t);if(err.name==='AbortError')throw new Error('TIMEOUT');throw err}
}

function parseDrawDate(s){if(!s)return null;s=String(s).trim();var p=s.split('-');if(p.length===3){var y=parseInt(p[0]),m=parseInt(p[1])-1,d=parseInt(p[2]);if(!isNaN(y)&&!isNaN(m)&&!isNaN(d)&&y>2000)return new Date(y,m,d)}var f=new Date(s);return isNaN(f.getTime())?null:f}
function formatDrawDate(s){var d=parseDrawDate(s);if(!d)return null;var mo=['January','February','March','April','May','June','July','August','September','October','November','December'],dy=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];return dy[d.getDay()]+', '+mo[d.getMonth()]+' '+d.getDate()+', '+d.getFullYear()}

function applyPublicSettings(s){
  if(s.lottery_name){LOTTERY_NAME=String(s.lottery_name).substring(0,60);document.title=LOTTERY_NAME;var p=LOTTERY_NAME.split(' '),logo=document.getElementById('logoText');logo.textContent='';var prefix=document.createTextNode('üé∞ '+(p.length>=2?p.slice(0,-1).join(' '):LOTTERY_NAME));logo.appendChild(prefix);if(p.length>=2){var sp=document.createElement('span');sp.textContent=p[p.length-1];logo.appendChild(sp);}}
  if(s.gcash_name){GCASH_NAME=String(s.gcash_name).substring(0,60);document.getElementById('dN').textContent=GCASH_NAME}
  if(s.gcash_number){GCASH_NUMBER=String(s.gcash_number).substring(0,20);document.getElementById('dP').textContent=GCASH_NUMBER}
  if(s.price_per_number>0){PRICE_PER=parseFloat(s.price_per_number)||1;document.getElementById('priceTag').textContent='‚Ç±'+PRICE_PER.toFixed(2).replace('1.00','1SO')+' PER ENTRY';document.getElementById('tagLine').textContent='Get your lucky numbers ‚Äî only ‚Ç±'+PRICE_PER.toFixed(2)+' each!'}
  if(s.min_quantity>0){MIN_QTY=parseInt(s.min_quantity)||100;document.getElementById('fQ').min=MIN_QTY;var ms=document.getElementById('minQtySpan');if(ms)ms.textContent=MIN_QTY}
  if(s.max_quantity>0){MAX_QTY=parseInt(s.max_quantity)||10000;document.getElementById('fQ').max=MAX_QTY}
  var fd=formatDrawDate(s.draw_date);
  if(fd){document.getElementById('drawDateText').textContent=fd;document.getElementById('drawBanner').style.display='block'}else{document.getElementById('drawBanner').style.display='none'}
  if(s.announcement&&s.announcement.trim()){document.getElementById('announceText').textContent=String(s.announcement).substring(0,500);document.getElementById('announceBanner').style.display='block'}else{document.getElementById('announceBanner').style.display='none'}
  if(s.maintenance_mode)document.getElementById('maintOverlay').classList.add('on');else document.getElementById('maintOverlay').classList.remove('on');
  calc();
}

function titleCase(s){return s.replace(/\b\w/g,c=>c.toUpperCase())}
function getDigitsOnly(s){return s.replace(/\D/g,'')}
function isValidPhone(s){var d=getDigitsOnly(s);return d.length===11&&d.startsWith('09')}
function updatePhoneStatus(){var r=document.getElementById('fP').value,d=getDigitsOnly(r),e=document.getElementById('phoneErr'),i=document.getElementById('fP');if(!r){e.style.display='none';i.style.borderColor='rgba(255,255,255,.1)';return}if(d.length===11&&d.startsWith('09')){e.style.display='none';i.style.borderColor='var(--ok)'}else{e.style.display='block';e.textContent=d.length<11?'Need 11 digits ('+d.length+'/11)':(!d.startsWith('09')?'Must start with 09':'Invalid');i.style.borderColor='var(--err)'}}
function setTodayDate(){document.getElementById('dateToday').textContent=new Date().toLocaleDateString('en-PH',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
function updateProgress(sold,rem){var pct=Math.max(0,Math.min(100,(rem/TOTAL_POOL)*100));var f=document.getElementById('progressFill'),t=document.getElementById('availTxt');f.style.width=pct+'%';f.classList.remove('mid','low');t.classList.remove('high','mid','low');if(pct>60){t.textContent='Plenty available';t.classList.add('high')}else if(pct>30){t.textContent='Selling fast';t.classList.add('mid');f.classList.add('mid')}else if(pct>10){t.textContent='Running low';t.classList.add('low');f.classList.add('low')}else{t.textContent=pct>0?'Almost sold out!':'Sold out';t.classList.add('low');f.classList.add('low')}}

async function checkConnection(){
  var bar=document.getElementById('connBar'),txt=document.getElementById('connTxt'),ep=document.getElementById('errPanel');
  bar.className='conn checking';txt.textContent='Connecting...';ep.classList.add('hide');
  if(SCRIPT_URL.includes('YOUR_')){bar.className='conn offline';txt.textContent='‚ö† Set SCRIPT_URL';return}
  var cs=cacheGet('pub_settings'),ct=cacheGet('pub_stats');
  if(cs){applyPublicSettings(cs.data);bar.className='conn online';txt.textContent='‚úì Connected';serverOnline=true}
  if(ct){updateProgress(ct.data.sold,ct.data.remaining)}
  if(cacheAge('pub_settings')<60000&&cacheAge('pub_stats')<60000)return;
  try{
    var[h,s,st]=await Promise.all([
      safeFetch(SCRIPT_URL+'?action=health',30000),
      safeFetch(SCRIPT_URL+'?action=publicSettings',30000),
      safeFetch(SCRIPT_URL+'?action=stats',30000)
    ]);
    if(h&&h.success){serverOnline=true;bar.className='conn online';txt.textContent='‚úì Connected'}
    if(s&&s.success){cacheSet('pub_settings',s);applyPublicSettings(s)}
    if(st&&st.success){cacheSet('pub_stats',st);updateProgress(st.sold,st.remaining)}
  }catch(err){
    if(!serverOnline){bar.className='conn offline';txt.textContent='‚úó '+(err.message==='TIMEOUT'?'Timed out ‚Äî tap Retry':err.message);document.getElementById('errDetail').innerHTML='<button class="retry-btn" onclick="checkConnection()">üîÑ Retry</button>';ep.classList.remove('hide');}
  }
}

function addQty(n){var cur=parseInt(document.getElementById('fQ').value)||0,next=cur+n;if(next>MAX_QTY){var canAdd=MAX_QTY-cur;if(canAdd<=0)return toast('Already at max ('+MAX_QTY.toLocaleString()+').','warn');next=MAX_QTY;toast('Capped at max '+MAX_QTY.toLocaleString(),'warn')}document.getElementById('fQ').value=next;calc();event.currentTarget.classList.add('qp-added');setTimeout(()=>event.currentTarget.classList.remove('qp-added'),350)}
function setMaxQtyFn(){if(parseInt(document.getElementById('fQ').value)===MAX_QTY)return toast('Already at max.','warn');document.getElementById('fQ').value=MAX_QTY;calc()}
function resetQty(){document.getElementById('fQ').value='';calc()}
function calc(){var v=Math.min(MAX_QTY,Math.max(0,parseInt(document.getElementById('fQ').value)||0));document.getElementById('dT').textContent='‚Ç± '+(v*PRICE_PER).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}
function go2(){
  var nm=sanitizeInput(document.getElementById('fN').value.trim(),MAX_NAME_LENGTH);
  var ph=document.getElementById('fP').value.trim();
  var qt=parseInt(document.getElementById('fQ').value);
  if(!nm||nm.length<2)return toast('Enter full name (2-'+MAX_NAME_LENGTH+' chars).','err');
  if(nm.length>MAX_NAME_LENGTH)return toast('Name max '+MAX_NAME_LENGTH+' characters.','err');
  if(!isValidPhone(ph))return toast('Phone must be 11 digits starting with 09.','err');
  if(!qt||qt<MIN_QTY){document.getElementById('fQ').value=MIN_QTY;calc();return toast('Min '+MIN_QTY+'.','err')}
  if(qt>MAX_QTY){document.getElementById('fQ').value=MAX_QTY;calc();return toast('Max '+MAX_QTY.toLocaleString()+'.','err')}
  hide('p1');show('p2');
  document.getElementById('dA').textContent=' ‚Ç± '+(qt*PRICE_PER).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  stpSet(2);
}
function go1(){hide('p2');show('p1');stpSet(1)}
function stpSet(n){var c=(id,cl)=>document.getElementById(id).className=cl;c('i1',n===1?'stp on':'stp ok');c('i2',n===2?'stp on':n>2?'stp ok':'stp');c('i3',n===3?'stp on':'stp');c('l1',n>=2?'sln on':'sln');c('l2',n>=3?'sln on':'sln')}

function submitPurchase(){
  var ref=document.getElementById('fR').value.trim();
  if(!ref)return toast('Enter GCash ref.','err');
  if(!/^\d{1,13}$/.test(ref))return toast('GCash ref must be digits only (max 13).','err');
  if(!serverOnline){toast('Offline.','err');checkConnection();return}
  var nm=sanitizeInput(document.getElementById('fN').value.trim(),MAX_NAME_LENGTH);
  var ph=getDigitsOnly(document.getElementById('fP').value.trim()).substring(0,11);
  var qt=parseInt(document.getElementById('fQ').value);
  if(!nm||nm.length<2)return toast('Invalid name.','err');
  if(nm.length>MAX_NAME_LENGTH)return toast('Name max '+MAX_NAME_LENGTH+' chars.','err');
  if(!isValidPhone(ph))return toast('Invalid phone.','err');
  if(!qt||qt<MIN_QTY||qt>MAX_QTY)return toast('Invalid quantity ('+MIN_QTY+'-'+MAX_QTY.toLocaleString()+').','err');
  document.getElementById('buyBtn').disabled=true;
  attemptPurchase(nm,ph,qt,ref,0)
}
async function attemptPurchase(nm,ph,qt,ref,tryN){
  if(tryN===0)showOv('Generating '+qt.toLocaleString()+' numbers...','This may take a moment for large quantities');
  else{showOv('Retry '+tryN+'/'+MAX_RETRY,'');await new Promise(r=>setTimeout(r,RETRY_MS[tryN-1]))}
  try{
    var d=await safeFetch(SCRIPT_URL+'?'+new URLSearchParams({action:'purchase',quantity:qt,name:nm,phone:ph,gcashRef:ref}),FETCH_TIMEOUT);
    if(d.success){hideOv();document.getElementById('buyBtn').disabled=false;myNums=d.numbers.map(n=>pad6(n));showResult(d,nm,ph,qt,ref);toast('‚è≥ '+d.quantity.toLocaleString()+' numbers reserved ‚Äî pending approval!','warn')}
    else if(d.retryable&&tryN<MAX_RETRY){toast('Retrying...','warn');attemptPurchase(nm,ph,qt,ref,tryN+1)}
    else{hideOv();document.getElementById('buyBtn').disabled=false;toast(d.error||'Failed.','err')}
  }catch(err){
    if(tryN<MAX_RETRY){toast('Retrying...','warn');attemptPurchase(nm,ph,qt,ref,tryN+1)}
    else{hideOv();document.getElementById('buyBtn').disabled=false;toast(err.message,'err')}
  }
}
function censorName(n){var p=n.trim().split(/\s+/);return p.map(function(w,i){return i===0?w:w.charAt(0)+'***'}).join(' ')}
function censorPhone(p){return p.substring(0,5)+'******'}
function showResult(d,nm,ph,qt,ref){hide('secB');show('secR');stpSet(3);document.getElementById('rI').textContent=d.transactionId;document.getElementById('rD').textContent=d.timestamp;document.getElementById('rN').textContent=censorName(nm);document.getElementById('rP').textContent=censorPhone(ph);document.getElementById('rQ').textContent=d.quantity.toLocaleString();document.getElementById('rA').textContent='‚Ç± '+Number(d.amount).toLocaleString(undefined,{minimumFractionDigits:2});document.getElementById('rR').textContent=ref;document.getElementById('rS').textContent='‚è≥ PENDING';document.getElementById('rC').textContent=myNums.length.toLocaleString();var h='';for(var i=0;i<myNums.length;i++)h+='<div class="ni">'+myNums[i]+'</div>';document.getElementById('nG').innerHTML=h;scrollTo({top:0,behavior:'smooth'})}
function cpA(){navigator.clipboard.writeText(myNums.join('\n')).then(()=>toast('Copied!','suc')).catch(()=>toast('Copy failed','err'))}
function dlA(){var tx=document.getElementById('rI').textContent,L=[LOTTERY_NAME,'TX: '+tx,'Date: '+document.getElementById('rD').textContent,'Name: '+document.getElementById('rN').textContent,'GCash Ref: '+document.getElementById('rR').textContent,'Status: PENDING APPROVAL','Qty: '+myNums.length,'Amount: '+document.getElementById('rA').textContent,'','NUMBERS:',''];for(var i=0;i<myNums.length;i++)L.push(myNums[i]);var b=new Blob([L.join('\n')],{type:'text/plain'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='Lucky6-'+tx+'.txt';a.click();toast('Downloaded!','suc')}
function prA(){var w=window.open('');var tx=esc(document.getElementById('rI').textContent),ref=esc(document.getElementById('rR').textContent),amt=esc(document.getElementById('rA').textContent),lname=esc(LOTTERY_NAME);var nums=myNums.map(n=>'<div class="n">'+esc(n)+'</div>').join('');w.document.write('<!DOCTYPE html><html><head><title>'+lname+'</title><style>body{font-family:monospace;padding:20px;font-size:12px}.g{display:grid;grid-template-columns:repeat(6,1fr);gap:3px}.n{border:1px solid #ddd;padding:5px;text-align:center;font-weight:bold;letter-spacing:2px}.pending{background:#fff3e0;border:2px solid #ff9800;padding:10px;margin:10px 0;text-align:center;font-weight:bold;border-radius:6px}.hi{background:#fffde7;border:2px solid #ffd700;padding:8px 14px;margin:6px 0;border-radius:6px;font-family:monospace;font-size:14px;font-weight:bold}</style></head><body><h1 style="text-align:center">'+lname+'</h1><div class="pending">‚è≥ STATUS: PENDING APPROVAL</div><div class="hi">TX: '+tx+'</div><div class="hi">GCash Ref: '+ref+'</div><p>Qty: '+esc(String(myNums.length))+' | '+amt+'</p><div class="g">'+nums+'</div></body></html>');w.document.close();setTimeout(()=>w.print(),300)}
function cpGC(){navigator.clipboard.writeText(GCASH_NUMBER.replace(/\D/g,'')).then(()=>toast('Copied!','suc')).catch(()=>{})}
function again(){hide('secR');show('secB');['fN','fP','fQ','fR'].forEach(id=>document.getElementById(id).value='');document.getElementById('dT').textContent='‚Ç± 0.00';document.getElementById('phoneErr').style.display='none';document.getElementById('fP').style.borderColor='rgba(255,255,255,.1)';hide('p2');show('p1');stpSet(1);myNums=[];scrollTo({top:0,behavior:'smooth'})}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ADMIN
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

async function adminApi(a,p){
  p=p||{};p.action=a;p.token=TOKEN;
  var c=new AbortController(),t=setTimeout(()=>c.abort(),60000);
  try{
    var r=await fetch(SCRIPT_URL+'?'+new URLSearchParams(p),{signal:c.signal,redirect:'follow'});
    clearTimeout(t);var txt=await r.text();
    try{return JSON.parse(txt)}catch(e){var m=txt.match(/\{[\s\S]*\}/);if(m)return JSON.parse(m[0]);throw new Error('Parse error')}
  }catch(err){clearTimeout(t);if(err.name==='AbortError')throw new Error('Timeout');throw err}
}

async function doLogin(){
  var u=document.getElementById('loginUser').value.trim(),p=document.getElementById('loginPass').value.trim();
  if(!u||!p)return toast('Enter credentials.','err');
  document.getElementById('loginBtn').disabled=true;showOv('Signing in...','');
  try{
    var d=await adminApi('adminLogin',{username:u,password:p});
    if(d.success){
      TOKEN=d.token;
      document.getElementById('adminUser').textContent=u;
      document.getElementById('adminLogin').style.display='none';
      document.getElementById('adminPanel').style.display='block';
      toast('Welcome!','suc');
      showOv('Loading panel...','');
      try{
        var init=await adminApi('adminInit');
        if(init&&init.success){
          _initData=init;
          cacheSet('admin_dash',init.dashboard);
          if(init.transactions)cacheSet('admin_tx_1',init.transactions);
          if(init.settings)cacheSet('admin_set',init.settings);
        }
      }catch(e){}
      hideOv();
      loadDashboard();
      startAutoRefresh();
      startKeepAlive();
      setTimeout(()=>{
        adminApi('adminTransactions',{page:2,perPage:30}).then(r=>{if(r&&r.success)cacheSet('admin_tx_2',r)}).catch(()=>{});
        adminApi('adminSoldNumbers',{page:1,perPage:100}).then(r=>{if(r&&r.success)cacheSet('admin_num_1',r)}).catch(()=>{});
      },800);
    }else toast(d.error,'err');
  }catch(e){toast(e.message,'err')}
  hideOv();document.getElementById('loginBtn').disabled=false;
}

function doLogout(){
  TOKEN='';_initData=null;cacheClear();txCacheInvalidate();
  document.getElementById('adminPanel').style.display='none';
  document.getElementById('adminLogin').style.display='flex';
  document.getElementById('loginUser').value='';document.getElementById('loginPass').value='';
  if(_art)clearInterval(_art);if(_kat)clearInterval(_kat);
  toast('Logged out.','warn');
}

var activeP='dashboard',_art=null,_kat=null;

function startKeepAlive(){
  if(_kat)clearInterval(_kat);
  _kat=setInterval(()=>{
    if(!TOKEN)return;
    fetch(SCRIPT_URL+'?action=health',{redirect:'follow'}).catch(()=>{});
  },55000);
}

function goPage(n){
  activeP=n;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('pg-'+n).classList.add('active');
  document.querySelectorAll('.sidebar .nav-item').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('[data-page="'+n+'"]').forEach(x=>x.classList.add('active'));
  document.querySelectorAll('.mob-nav .nav-item').forEach(x=>{x.classList.remove('active');if(x.textContent.toLowerCase().includes(n.substring(0,4)))x.classList.add('active')});
  if(n==='dashboard')loadDashboard();
  if(n==='transactions')loadTransactions();
  if(n==='numbers')loadNumbers();
  if(n==='settings')loadSettingsFn();
}
function statusClass(s){if(s==='APPROVED')return'ok';if(s==='PENDING')return'pend';if(s==='DECLINED')return'dec';return'fail'}

function refreshDashboard(){cacheClear('admin_dash');_initData=null;txCacheInvalidate();loadDashboard();}

async function loadDashboard(){
  if(_initData&&_initData.dashboard&&cacheAge('admin_dash')<30000){renderDashboard(_initData.dashboard);return;}
  await swr('admin_dash',
    async()=>{var d=await adminApi('adminDashboard');return d.success?d:null;},
    d=>{if(d)renderDashboard(d);}
  );
}

function renderDashboard(d){
  document.getElementById('dsSold').textContent=d.totalSold.toLocaleString();
  document.getElementById('dsRemain').textContent=d.remaining.toLocaleString();
  document.getElementById('dsPct').textContent=d.percentSold+'% sold';
  document.getElementById('dsRevenue').textContent='‚Ç±'+Number(d.totalRevenue).toLocaleString();
  document.getElementById('dsPending').textContent=d.pendingTransactions.toLocaleString();
  document.getElementById('dsApproved').textContent=d.approvedTransactions.toLocaleString();
  document.getElementById('dsDeclined').textContent=d.declinedTransactions.toLocaleString();
  document.getElementById('dsBuyers').textContent=d.uniqueBuyers.toLocaleString();
  var pct=d.totalSold/d.totalPool*100,bar=document.getElementById('dsBar');
  bar.style.width=pct+'%';bar.classList.remove('mid','low');
  if(pct>70)bar.classList.add('low');else if(pct>40)bar.classList.add('mid');
  var list=document.getElementById('feedList'),acts=d.recentActivity||[];
  if(!acts.length){list.innerHTML='<li class="tbl-empty">No activity.</li>';return}
  var h='';
  acts.forEach(a=>{var dc=statusClass(a.status),txE=esc(a.transactionId);
    h+='<li style="cursor:pointer;align-items:flex-start" onclick="openTxDetail(\''+txE+'\')"><div class="dot '+dc+'" style="margin-top:4px;flex-shrink:0"></div><div style="flex:1;min-width:0"><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:6px"><strong style="word-break:break-word">'+esc(a.name)+'</strong><span class="badge '+dc+'" style="flex-shrink:0;margin-left:4px">'+esc(a.status)+'</span></div><div style="font-size:.8rem;color:var(--sub);margin-top:2px">'+esc(String(a.quantity))+' entries ¬∑ ‚Ç±'+Number(a.amount).toLocaleString()+'</div><span class="time" style="display:block;margin-top:2px">'+esc(a.timestamp)+'<br>'+txE+'</span></div></li>';
  });
  list.innerHTML=h;
}

function buildTxActions(status,txId){
  var a='<div class="tx-actions">';
  if(status==='PENDING')a+='<button class="btn-sm btn-green" onclick="event.stopPropagation();confirmApprove(\''+txId+'\')">Approve</button><button class="btn-sm btn-red" onclick="event.stopPropagation();confirmDecline(\''+txId+'\')">Decline</button>';
  a+='<button class="btn-sm btn-orange" onclick="event.stopPropagation();confirmDelete(\''+txId+'\')">Delete</button></div>';
  return a;
}

function renderTransactions(d){
  var b=document.getElementById('txBody');
  if(!d.transactions||!d.transactions.length){b.innerHTML='<tr><td colspan="9" class="tbl-empty">None.</td></tr>';document.getElementById('txPagination').innerHTML='';return}
  var h='';
  d.transactions.forEach(t=>{var sc=statusClass(t.status),txE=esc(t.transactionId);
    h+='<tr data-tx="'+txE+'" class="clickable-row" onclick="openTxDetail(\''+txE+'\')"><td>'+esc(t.timestamp)+'</td><td class="mono" style="font-size:.73rem">'+txE+'</td><td>'+esc(t.name)+'</td><td>'+esc(t.phone)+'</td><td>'+esc(t.gcashRef)+'</td><td>'+esc(String(t.quantity))+'</td><td>‚Ç±'+Number(t.amount).toLocaleString()+'</td><td id="st_'+txE+'"><span class="badge '+sc+'">'+esc(t.status)+'</span></td><td>'+buildTxActions(t.status,txE)+'</td></tr>';
  });
  b.innerHTML=h;
  renderPg('txPagination',d.page,d.totalPages,'loadTransactions');
  if(d.page<d.totalPages){
    setTimeout(()=>{
      var nk='admin_tx_'+(d.page+1);
      if(cacheAge(nk)>30000)adminApi('adminTransactions',{page:d.page+1,perPage:30}).then(r=>{if(r&&r.success)cacheSet(nk,r)}).catch(()=>{});
    },500);
  }
}

function refreshTransactions(){cacheClear('admin_tx');_initData=null;loadTransactions();}

async function loadTransactions(pg){
  if(pg)currentPage.tx=pg;
  if(currentPage.tx===1&&_initData&&_initData.transactions&&cacheAge('admin_tx_1')<30000){renderTransactions(_initData.transactions);return;}
  await swr('admin_tx_'+currentPage.tx,
    async()=>{var d=await adminApi('adminTransactions',{page:currentPage.tx,perPage:30});return d.success?d:null;},
    d=>{if(d)renderTransactions(d);}
  );
}

function refreshNumbers(){cacheClear('admin_num');loadNumbers();}

async function loadNumbers(pg){
  if(pg)currentPage.num=pg;
  await swr('admin_num_'+currentPage.num,
    async()=>{var d=await adminApi('adminSoldNumbers',{page:currentPage.num,perPage:100});return d.success?d:null;},
    d=>{
      if(!d)return;
      var b=document.getElementById('numBody');
      if(!d.numbers.length){b.innerHTML='<tr><td colspan="6" class="tbl-empty">None.</td></tr>';document.getElementById('numPagination').innerHTML='';return}
      var h='';
      d.numbers.forEach(n=>{var txE=esc(n.transactionId);h+='<tr class="clickable-row" onclick="openTxDetail(\''+txE+'\')"><td class="mono">'+esc(n.number)+'</td><td style="font-size:.73rem">'+txE+'</td><td>'+esc(n.name)+'</td><td>'+esc(n.phone)+'</td><td>'+esc(n.gcashRef)+'</td><td>'+esc(n.timestamp)+'</td></tr>';});
      b.innerHTML=h;renderPg('numPagination',d.page,d.totalPages,'loadNumbers');
    }
  );
}

function renderPg(cid,cur,tot,fn){
  var c=document.getElementById(cid);if(tot<=1){c.innerHTML='';return}
  var h='<button class="pg-btn" onclick="'+fn+'('+(cur-1)+')" '+(cur<=1?'disabled':'')+'>‚Üê</button>';
  var s=Math.max(1,cur-2),e=Math.min(tot,cur+2);
  if(s>1)h+='<button class="pg-btn" onclick="'+fn+'(1)">1</button>';if(s>2)h+='<span class="pg-info">‚Ä¶</span>';
  for(var i=s;i<=e;i++)h+='<button class="pg-btn'+(i===cur?' active':'')+'" onclick="'+fn+'('+i+')">'+i+'</button>';
  if(e<tot-1)h+='<span class="pg-info">‚Ä¶</span>';if(e<tot)h+='<button class="pg-btn" onclick="'+fn+'('+tot+')">'+tot+'</button>';
  h+='<button class="pg-btn" onclick="'+fn+'('+(cur+1)+')" '+(cur>=tot?'disabled':'')+'>‚Üí</button> <span class="pg-info">'+cur+'/'+tot+'</span>';
  c.innerHTML=h;
}

async function openTxDetail(txId){
  var cached=txCacheGet(txId);
  if(cached){renderTxDetail(cached);document.getElementById('detailModal').classList.add('on');return;}
  showOv('Loading details...','');
  try{
    var d=await adminApi('adminGetTransaction',{transactionId:txId});
    hideOv();
    if(!d.success){toast(d.error||'Not found','err');return}
    txCacheSet(txId,d);
    renderTxDetail(d);
    document.getElementById('detailModal').classList.add('on');
  }catch(e){hideOv();toast('Error: '+e.message,'err')}
}

function renderTxDetail(d){
  var tx=d.transaction;_detailTx=tx;
  document.getElementById('detailTitle').innerHTML='üìã Transaction Detail';
  document.getElementById('detailSub').textContent=tx.transactionId;
  var g='';
  g+='<div class="ri"><div class="rl">Transaction ID</div><div class="rv" style="font-family:JetBrains Mono,monospace;color:var(--gold)">'+esc(tx.transactionId)+'</div></div>';
  g+='<div class="ri"><div class="rl">Date</div><div class="rv">'+esc(tx.timestamp)+'</div></div>';
  g+='<div class="ri"><div class="rl">Name</div><div class="rv">'+esc(tx.name)+'</div></div>';
  g+='<div class="ri"><div class="rl">Phone</div><div class="rv">'+esc(tx.phone)+'</div></div>';
  g+='<div class="ri"><div class="rl">GCash Ref</div><div class="rv">'+esc(tx.gcashRef)+'</div></div>';
  g+='<div class="ri"><div class="rl">Quantity</div><div class="rv">'+Number(tx.quantity).toLocaleString()+'</div></div>';
  g+='<div class="ri"><div class="rl">Amount</div><div class="rv" style="color:var(--gold);font-weight:800">‚Ç±'+Number(tx.amount).toLocaleString()+'</div></div>';
  g+='<div class="ri"><div class="rl">Status</div><div class="rv"><span class="badge '+statusClass(tx.status)+'">'+esc(tx.status)+'</span></div></div>';
  document.getElementById('detailGrid').innerHTML=g;
  var allNums=[],nh='';
  if(tx.soldNumbers&&tx.soldNumbers.length>0){
    allNums=tx.soldNumbers;
    nh+='<h3>üé∞ Numbers ('+tx.soldCount.toLocaleString()+' in registry)</h3><div class="nbox" style="max-height:300px"><div class="ngrid">';
    tx.soldNumbers.forEach(n=>{nh+='<div class="ni">'+esc(n)+'</div>'});
    nh+='</div></div>';
  }else if(tx.numbers&&tx.numbers.trim()){
    var nums=tx.numbers.split(',').map(n=>n.trim()).filter(n=>n);
    allNums=nums.map(n=>pad6(n));
    nh+='<h3>üé∞ Numbers ('+nums.length.toLocaleString()+' from log)</h3>';
    if(tx.status==='DECLINED')nh+='<div style="font-size:.78rem;color:var(--err);margin-bottom:8px">‚ö†Ô∏è Numbers were freed (declined)</div>';
    nh+='<div class="nbox" style="max-height:300px"><div class="ngrid">';
    nums.slice(0,500).forEach(n=>{nh+='<div class="ni" style="opacity:'+(tx.status==='DECLINED'?'.4':'1')+'">'+pad6(n)+'</div>'});
    if(nums.length>500)nh+='<div style="text-align:center;padding:10px;color:var(--sub)">...and '+(nums.length-500).toLocaleString()+' more</div>';
    nh+='</div></div>';
  }else{nh+='<h3>üé∞ Numbers</h3><div style="color:var(--sub);font-size:.85rem;padding:10px">No numbers data available.</div>';}
  _detailTx._allNums=allNums;
  document.getElementById('detailNums').innerHTML=nh;
  var ah='';
  if(allNums.length>0){ah+='<button class="btn-sm btn-blue" onclick="copyDetailNums()">üìã Copy All Numbers</button><button class="btn-sm btn-green" onclick="downloadDetailTx()">‚¨á Download TXT</button>';}
  if(tx.status==='PENDING'){ah+='<button class="btn-sm btn-green" onclick="closeDetail();confirmApprove(\''+esc(tx.transactionId)+'\')">‚úÖ Approve</button><button class="btn-sm btn-red" onclick="closeDetail();confirmDecline(\''+esc(tx.transactionId)+'\')">‚ùå Decline</button>';}
  ah+='<button class="btn-sm btn-blue" onclick="closeDetail()">Close</button>';
  document.getElementById('detailActions').innerHTML=ah;
}

function copyDetailNums(){if(!_detailTx||!_detailTx._allNums||!_detailTx._allNums.length)return toast('No numbers','err');navigator.clipboard.writeText(_detailTx._allNums.join('\n')).then(()=>toast('üìã Copied '+_detailTx._allNums.length.toLocaleString()+' numbers!','suc')).catch(()=>toast('Copy failed','err'))}
function downloadDetailTx(){if(!_detailTx)return;var tx=_detailTx,nums=tx._allNums||[];var L=[LOTTERY_NAME,'','TX: '+tx.transactionId,'Date: '+tx.timestamp,'Name: '+tx.name,'Phone: '+tx.phone,'GCash Ref: '+tx.gcashRef,'Status: '+tx.status,'Qty: '+tx.quantity,'Amount: ‚Ç±'+Number(tx.amount).toLocaleString(),'','NUMBERS ('+nums.length+'):',''];nums.forEach(n=>L.push(n));var b=new Blob([L.join('\n')],{type:'text/plain'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='Lucky6-'+tx.transactionId+'.txt';a.click();toast('‚¨á Downloaded!','suc')}

function _optimisticStatus(txId,newStatus){
  var cell=document.getElementById('st_'+txId);
  if(cell)cell.innerHTML='<span class="badge '+statusClass(newStatus)+'">'+newStatus+'</span>';
  txCacheInvalidate(txId);
}

function confirmApprove(tx){document.getElementById('confirmTitle').textContent='‚úÖ Approve Transaction?';document.getElementById('confirmMsg').innerHTML='Approve <code>'+esc(tx)+'</code>?<br>This confirms payment has been verified.';document.getElementById('confirmYes').textContent='Approve';document.getElementById('confirmYes').className='btn-sm btn-green';document.getElementById('confirmYes').onclick=()=>doApprove(tx);document.getElementById('confirmModal').classList.add('on')}
async function doApprove(tx){
  closeConfirm();
  _optimisticStatus(tx,'APPROVED');
  cacheClear('admin_dash');cacheClear('admin_tx');_initData=null;
  try{
    var d=await adminApi('adminApproveTransaction',{transactionId:tx});
    if(d.success){toast('‚úÖ '+d.message,'suc');loadDashboard();}
    else{toast(d.error,'err');_optimisticStatus(tx,'PENDING');loadTransactions();}
  }catch(e){toast('Failed','err');_optimisticStatus(tx,'PENDING');loadTransactions();}
}

function confirmDecline(tx){document.getElementById('confirmTitle').textContent='‚ùå Decline Transaction?';document.getElementById('confirmMsg').innerHTML='Decline <code>'+esc(tx)+'</code>?<br>This will free up the reserved numbers.';document.getElementById('confirmYes').textContent='Decline';document.getElementById('confirmYes').className='btn-sm btn-red';document.getElementById('confirmYes').onclick=()=>doDecline(tx);document.getElementById('confirmModal').classList.add('on')}
async function doDecline(tx){
  closeConfirm();
  _optimisticStatus(tx,'DECLINED');
  cacheClear('admin_');_initData=null;txCacheInvalidate();
  try{
    var d=await adminApi('adminDeclineTransaction',{transactionId:tx});
    if(d.success){toast('‚ùå '+d.message,'suc');loadDashboard();loadTransactions();}
    else{toast(d.error,'err');loadTransactions();}
  }catch(e){toast('Failed','err');loadTransactions();}
}

function confirmDelete(tx){document.getElementById('confirmTitle').textContent='üóëÔ∏è Permanently Delete?';document.getElementById('confirmMsg').innerHTML='Completely erase <code>'+esc(tx)+'</code> from ALL sheets.<br><strong>This cannot be undone!</strong>';document.getElementById('confirmYes').textContent='Delete Forever';document.getElementById('confirmYes').className='btn-sm btn-orange';document.getElementById('confirmYes').onclick=()=>doDelete(tx);document.getElementById('confirmModal').classList.add('on')}
async function doDelete(tx){
  closeConfirm();
  var row=document.querySelector('tr[data-tx="'+tx+'"]');
  if(row){row.classList.add('row-deleting');setTimeout(()=>row.remove(),400)}
  toast('Deleting...','warn');cacheClear('admin_');_initData=null;txCacheInvalidate();
  try{
    var d=await adminApi('adminDeleteTransaction',{transactionId:tx});
    if(d.success){toast('üóëÔ∏è '+d.message,'suc');loadDashboard();loadTransactions();}
    else{toast(d.error,'err');loadTransactions();}
  }catch(e){toast('Failed','err');loadTransactions();}
}

function confirmDeleteAll(){document.getElementById('confirmTitle').textContent='üóëÔ∏è Delete ALL Transactions?';document.getElementById('confirmMsg').innerHTML='Permanently erase <strong>every transaction and all sold numbers</strong>.<br><br><strong style="color:var(--err)">This cannot be undone!</strong>';document.getElementById('confirmYes').textContent='Delete Everything';document.getElementById('confirmYes').className='btn-sm btn-red';document.getElementById('confirmYes').onclick=()=>doDeleteAll();document.getElementById('confirmModal').classList.add('on')}
async function doDeleteAll(){closeConfirm();showOv('Deleting all transactions...','');cacheClear('admin_');_initData=null;txCacheInvalidate();try{var d=await adminApi('adminDeleteAllTransactions');hideOv();if(d.success){toast('üóëÔ∏è All transactions deleted.','suc');loadDashboard();loadTransactions()}else{toast(d.error||'Failed.','err')}}catch(e){hideOv();toast('Error: '+e.message,'err')}}

async function searchNumber(){
  var q=document.getElementById('searchNum').value.trim(); if(!q)return toast('Enter number.','err');
  document.getElementById('sl1').classList.add('on');
  document.getElementById('searchResults').style.display='none';
  try{
    var d=await adminApi('adminSearchNumber',{query:q});
    document.getElementById('sl1').classList.remove('on');
    document.getElementById('searchResults').style.display='block';
    document.getElementById('searchTitle').textContent=d.found?'‚úÖ '+d.query+' found ‚Äî click to view details':'‚ùå Not found';
    if(d.found){
      document.getElementById('searchThead').innerHTML='<tr><th>Number</th><th>TX</th><th>Name</th><th>Phone</th><th>GCash</th><th>Date</th></tr>';
      var h='';d.results.forEach(r=>{var txE=esc(r.transactionId);h+='<tr class="clickable-row" onclick="openTxDetail(\''+txE+'\')"><td class="mono">'+esc(r.number)+'</td><td>'+txE+'</td><td>'+esc(r.name)+'</td><td>'+esc(r.phone)+'</td><td>'+esc(r.gcashRef)+'</td><td>'+esc(r.timestamp)+'</td></tr>'});
      document.getElementById('searchTbody').innerHTML=h;
    }else{document.getElementById('searchThead').innerHTML='';document.getElementById('searchTbody').innerHTML='<tr><td class="tbl-empty">Not sold.</td></tr>';}
  }catch(e){document.getElementById('sl1').classList.remove('on');toast('Error','err')}
}

async function searchBuyerFn(){
  var q=document.getElementById('searchBuyer').value.trim(); if(!q)return toast('Enter term.','err');
  document.getElementById('sl2').classList.add('on');
  document.getElementById('searchResults').style.display='none';
  try{
    var d=await adminApi('adminSearchBuyer',{query:q});
    document.getElementById('sl2').classList.remove('on');
    document.getElementById('searchResults').style.display='block';
    document.getElementById('searchTitle').textContent=d.total+' result(s) ‚Äî click to view details';
    if(d.total>0){
      document.getElementById('searchThead').innerHTML='<tr><th>Date</th><th>TX</th><th>Name</th><th>Phone</th><th>Qty</th><th>Amt</th><th>Status</th></tr>';
      var h='';d.results.forEach(r=>{var sc=statusClass(r.status),txE=esc(r.transactionId);h+='<tr class="clickable-row" onclick="openTxDetail(\''+txE+'\')"><td>'+esc(r.timestamp)+'</td><td>'+txE+'</td><td>'+esc(r.name)+'</td><td>'+esc(r.phone)+'</td><td>'+esc(String(r.quantity))+'</td><td>‚Ç±'+Number(r.amount).toLocaleString()+'</td><td><span class="badge '+sc+'">'+esc(r.status)+'</span></td></tr>'});
      document.getElementById('searchTbody').innerHTML=h;
    }else{document.getElementById('searchThead').innerHTML='';document.getElementById('searchTbody').innerHTML='<tr><td class="tbl-empty">None.</td></tr>';}
  }catch(e){document.getElementById('sl2').classList.remove('on');toast('Error','err')}
}

async function addNumber(){var num=document.getElementById('addNum').value.trim();if(!num)return toast('Enter number.','err');showOv('Adding...','');try{var d=await adminApi('adminAddNumber',{number:num,name:document.getElementById('addName').value.trim()||'ADMIN',phone:document.getElementById('addPhone').value.trim()||'N/A'});hideOv();if(d.success){toast(d.message,'suc');['addNum','addName','addPhone'].forEach(id=>document.getElementById(id).value='');cacheClear('admin_');_initData=null;txCacheInvalidate();}else toast(d.error,'err')}catch(e){hideOv();toast('Error','err')}}
async function removeNumber(){var num=document.getElementById('removeNum').value.trim();if(!num)return toast('Enter number.','err');document.getElementById('confirmTitle').textContent='Remove?';document.getElementById('confirmMsg').innerHTML='Remove <code>'+num.padStart(6,'0')+'</code>?';document.getElementById('confirmYes').textContent='Remove';document.getElementById('confirmYes').className='btn-sm btn-red';document.getElementById('confirmYes').onclick=async()=>{closeConfirm();showOv('Removing...','');try{var d=await adminApi('adminRemoveNumber',{number:num});hideOv();if(d.success){toast(d.message,'suc');document.getElementById('removeNum').value='';cacheClear('admin_');_initData=null;}else toast(d.error,'err')}catch(e){hideOv();toast('Error','err')}};document.getElementById('confirmModal').classList.add('on')}

async function loadSettingsFn(){
  if(_initData&&_initData.settings&&cacheAge('admin_set')<60000){_applySettingsToForm(_initData.settings);return;}
  await swr('admin_set',
    async()=>{var d=await adminApi('adminGetSettings');return d.success?d.settings:null;},
    s=>{if(s)_applySettingsToForm(s);}
  );
}
function _applySettingsToForm(s){
  document.getElementById('setGcashName').value=s.gcash_name||'';
  document.getElementById('setGcashNum').value=s.gcash_number||'';
  document.getElementById('setLotteryName').value=s.lottery_name||'';
  document.getElementById('setDrawDate').value=s.draw_date||'';
  document.getElementById('setPrice').value=s.price_per_number||'1';
  document.getElementById('setMinQty').value=s.min_quantity||'100';
  document.getElementById('setMaxQty').value=s.max_quantity||'10000';
  document.getElementById('setAnnouncement').value=s.announcement||'';
  document.getElementById('setMaintenance').value=s.maintenance_mode||'false';
}
async function saveSettings(){
  var np=document.getElementById('setNewPass').value,np2=document.getElementById('setNewPass2').value;
  if(np&&np.length<6)return toast('Min 6 chars.','err');
  if(np&&np!==np2)return toast('No match.','err');
  showOv('Saving...','');
  var p={gcash_name:document.getElementById('setGcashName').value.trim(),gcash_number:document.getElementById('setGcashNum').value.trim(),lottery_name:document.getElementById('setLotteryName').value.trim(),draw_date:document.getElementById('setDrawDate').value,price_per_number:document.getElementById('setPrice').value,min_quantity:document.getElementById('setMinQty').value,max_quantity:document.getElementById('setMaxQty').value,announcement:document.getElementById('setAnnouncement').value.trim(),maintenance_mode:document.getElementById('setMaintenance').value};
  if(np)p.new_password=np;
  try{var d=await adminApi('adminUpdateSettings',p);hideOv();if(d.success){toast('‚úÖ Saved!','suc');cacheClear();_initData=null;document.getElementById('setNewPass').value='';document.getElementById('setNewPass2').value='';if(np){toast('Password changed.','warn');setTimeout(doLogout,2000)}}else toast(d.error,'err')}catch(e){hideOv();toast('Error','err')}
}

async function exportData(type){showOv('Exporting...','');try{var d=await adminApi('adminExportData',{type});hideOv();if(!d.success)return toast(d.error,'err');var csv=d.headers.join(',')+'\n';d.data.forEach(r=>{csv+=r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')+'\n'});var b=new Blob([csv],{type:'text/csv'});var a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='Lucky6-'+type+'-'+new Date().toISOString().slice(0,10)+'.csv';a.click();toast('Exported '+(d.total||0)+' rows!','suc')}catch(e){hideOv();toast('Error','err')}}

function startAutoRefresh(){
  if(_art)clearInterval(_art);
  _art=setInterval(()=>{
    if(!TOKEN)return;
    if(activeP==='dashboard'&&cacheAge('admin_dash')>=30000){
      adminApi('adminDashboard').then(d=>{if(d&&d.success){cacheSet('admin_dash',d);if(activeP==='dashboard')renderDashboard(d);}}).catch(()=>{});
    }
  },5000);
}

document.addEventListener('DOMContentLoaded',async()=>{
  detectMode();
  if(IS_ADMIN_MODE){
    document.getElementById('loginPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
    document.getElementById('loginUser').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('loginPass').focus()});
  }else{
    setTodayDate();
    document.getElementById('dP').textContent=GCASH_NUMBER;
    document.getElementById('dN').textContent=GCASH_NAME;
    var ni=document.getElementById('fN');
    ni.maxLength=MAX_NAME_LENGTH;
    ni.addEventListener('input',()=>{
      var p=ni.selectionStart;
      // Strip dangerous chars on input
      ni.value=ni.value.replace(/[<>"'`;{}()\\]/g,'');
      ni.value=ni.value.replace(/\b\w/g,c=>c.toUpperCase());
      if(ni.value.length>MAX_NAME_LENGTH)ni.value=ni.value.substring(0,MAX_NAME_LENGTH);
      ni.setSelectionRange(Math.min(p,ni.value.length),Math.min(p,ni.value.length));
    });
    var pi=document.getElementById('fP');
    pi.addEventListener('input',()=>{pi.value=getDigitsOnly(pi.value).substring(0,11);updatePhoneStatus()});
    pi.addEventListener('blur',updatePhoneStatus);
    var qi=document.getElementById('fQ');
    qi.addEventListener('input',()=>calc());
    qi.addEventListener('blur',()=>{var v=parseInt(qi.value);if(!isNaN(v)&&v<MIN_QTY&&qi.value!==''){qi.value=MIN_QTY;toast('Min '+MIN_QTY,'warn')}if(!isNaN(v)&&v>MAX_QTY){qi.value=MAX_QTY;toast('Max '+MAX_QTY.toLocaleString(),'warn')}calc()});
    checkConnection();
    setInterval(setTodayDate,60000);
  }
  document.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&IS_ADMIN_MODE){
      if(document.activeElement===document.getElementById('searchNum'))searchNumber();
      if(document.activeElement===document.getElementById('searchBuyer'))searchBuyerFn();
    }
  });
});
</script>
